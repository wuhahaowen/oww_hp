(function(b,f){typeof exports=="object"&&typeof module<"u"?f(exports,require("three"),require("three/examples/jsm/postprocessing/EffectComposer.js"),require("three/examples/jsm/postprocessing/RenderPass.js"),require("three/examples/jsm/postprocessing/ShaderPass.js"),require("three/examples/jsm/postprocessing/OutputPass.js"),require("three/examples/jsm/postprocessing/UnrealBloomPass.js"),require("three/examples/jsm/postprocessing/OutlinePass.js"),require("three/examples/jsm/postprocessing/SSRPass.js"),require("three/examples/jsm/objects/Reflector.js"),require("three/examples/jsm/objects/ReflectorForSSRPass.js"),require("three/examples/jsm/shaders/HorizontalBlurShader.js"),require("three/examples/jsm/shaders/VerticalBlurShader.js"),require("three/examples/jsm/renderers/CSS2DRenderer.js"),require("three/examples/jsm/lights/RectAreaLightUniformsLib.js"),require("three/examples/jsm/helpers/RectAreaLightHelper.js"),require("three/examples/jsm/controls/OrbitControls.js"),require("three/examples/jsm/libs/stats.module.js"),require("@tweenjs/tween.js")):typeof define=="function"&&define.amd?define(["exports","three","three/examples/jsm/postprocessing/EffectComposer.js","three/examples/jsm/postprocessing/RenderPass.js","three/examples/jsm/postprocessing/ShaderPass.js","three/examples/jsm/postprocessing/OutputPass.js","three/examples/jsm/postprocessing/UnrealBloomPass.js","three/examples/jsm/postprocessing/OutlinePass.js","three/examples/jsm/postprocessing/SSRPass.js","three/examples/jsm/objects/Reflector.js","three/examples/jsm/objects/ReflectorForSSRPass.js","three/examples/jsm/shaders/HorizontalBlurShader.js","three/examples/jsm/shaders/VerticalBlurShader.js","three/examples/jsm/renderers/CSS2DRenderer.js","three/examples/jsm/lights/RectAreaLightUniformsLib.js","three/examples/jsm/helpers/RectAreaLightHelper.js","three/examples/jsm/controls/OrbitControls.js","three/examples/jsm/libs/stats.module.js","@tweenjs/tween.js"],f):(b=typeof globalThis<"u"?globalThis:b||self,f(b.Aether3dEngine=b.Aether3dEngine||{},b.THREE,b.EffectComposer_js,b.RenderPass_js,b.ShaderPass_js,b.OutputPass_js,b.UnrealBloomPass_js,b.OutlinePass_js,b.SSRPass_js,b.Reflector_js,b.ReflectorForSSRPass_js,b.HorizontalBlurShader_js,b.VerticalBlurShader_js,b.CSS2DRenderer_js,b.RectAreaLightUniformsLib_js,b.RectAreaLightHelper_js,b.OrbitControls_js,b.stats_module_js,b.TWEEN))})(this,function(b,f,D,q,Re,ae,ce,Ie,_e,X,De,$,Y,V,le,he,de,Ee,je){"use strict";var is=Object.defineProperty;var rs=(b,f,D)=>f in b?is(b,f,{enumerable:!0,configurable:!0,writable:!0,value:D}):b[f]=D;var l=(b,f,D)=>rs(b,typeof f!="symbol"?f+"":f,D);function ue(h){const s=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(h){for(const e in h)if(e!=="default"){const t=Object.getOwnPropertyDescriptor(h,e);Object.defineProperty(s,e,t.get?t:{enumerable:!0,get:()=>h[e]})}}return s.default=h,Object.freeze(s)}const p=ue(f),E=ue(je);class A{constructor(){l(this,"name");l(this,"uuid");l(this,"host",null);l(this,"renderer",null)}get scene(){if(this.renderer)return this.renderer.scene;throw new Error("Renderer not available")}get camera(){if(this.renderer)return this.renderer.camera;throw new Error("Renderer not available")}get webGLRenderer(){if(this.renderer)return this.renderer.renderer;throw new Error("Renderer not available")}get postProcessingComposer(){return this.renderer?this.renderer.getPostProcessingComposer():null}isObjectSelectable(s){return console.log(s.name),!0}setRenderer(s){this.renderer=s}engine(){return this.renderer}addScript(s){this.renderer&&this.renderer.addScript(s)}removeScript(s){this.renderer&&this.renderer.removeScript(s)}onResize(){}addObject(s){this.scene.add(s)}removeObject(s){this.scene.remove(s)}getSceneObjects(){return this.scene.children}findObjectByName(s){return this.scene.getObjectByName(s)}setCameraPosition(s,e,t){this.camera.position.set(s,e,t)}lookAt(s,e,t){this.camera.lookAt(s,e,t)}addPostProcessingPass(s,e=!0){this.renderer?this.renderer.addPostProcessingPass(s,e):console.warn("[ScriptBase] Renderer not available for adding post-processing pass")}removePostProcessingPass(s){this.renderer?this.renderer.removePostProcessingPass(s):console.warn("[ScriptBase] Renderer not available for removing post-processing pass")}}class fe{constructor(s){l(this,"composer",null);l(this,"renderPass",null);l(this,"outputPass",null);l(this,"renderer");l(this,"isEnabled",!1);l(this,"isHighPerformanceDeviceCached",null);l(this,"lastWidth",0);l(this,"lastHeight",0);this.renderer=s,this.init()}isHighPerformanceDevice(){return this.isHighPerformanceDeviceCached!==null?this.isHighPerformanceDeviceCached:!1}init(){try{this.composer=new D.EffectComposer(this.renderer.renderer);const s=this.isHighPerformanceDevice()?18:8;this.composer.renderTarget1.samples=s,this.composer.renderTarget2.samples=s,this.renderPass=new q.RenderPass(this.renderer.scene,this.renderer.camera),this.composer.addPass(this.renderPass),this.outputPass=new ae.OutputPass,this.composer.addPass(this.outputPass),console.log("[PostProcessingEffectComposer] EffectComposer initialized successfully")}catch(s){console.error("[PostProcessingEffectComposer] Failed to initialize EffectComposer:",s)}}enable(){this.isEnabled=!0,console.log("[PostProcessingEffectComposer] Post-processing enabled")}disable(){this.isEnabled=!1,console.log("[PostProcessingEffectComposer] Post-processing disabled")}isEnabledPostProcessing(){return this.isEnabled&&this.composer!==null}getComposer(){return this.composer}setPixelRatio(s){var e;(e=this.composer)==null||e.setPixelRatio(s)}addPass(s,e=!0){if(!this.composer){console.warn("[PostProcessingEffectComposer] Composer not initialized");return}try{if(e&&this.outputPass){const t=this.composer.passes,i=t.indexOf(this.outputPass);i>0?t.splice(i,0,s):this.composer.addPass(s)}else this.composer.addPass(s);s&&typeof s.setSize=="function"&&s.setSize(window.innerWidth,window.innerHeight),console.log("[PostProcessingEffectComposer] Pass added successfully")}catch(t){console.error("[PostProcessingEffectComposer] Failed to add pass:",t)}}removePass(s){if(!this.composer)return;const e=this.composer.passes.indexOf(s);e!==-1&&(this.composer.passes.splice(e,1),console.log("[PostProcessingEffectComposer] Pass removed successfully"))}getPasses(){return this.composer?this.composer.passes:[]}render(){this.composer&&this.composer.render()}setSize(s,e){if(!(this.lastWidth===s&&this.lastHeight===e)){if(this.lastWidth=s,this.lastHeight=e,this.composer){this.composer.setSize(s,e);for(const t of this.composer.passes)t&&typeof t.setSize=="function"&&t.setSize(s,e)}console.log(`[PostProcessingEffectComposer] Size updated to ${s}x${e}`)}}dispose(){this.composer&&(this.composer.passes.forEach(s=>{s&&typeof s.dispose=="function"&&s.dispose()}),this.composer=null,this.renderPass=null,this.outputPass=null,this.isEnabled=!1,console.log("[PostProcessingEffectComposer] Disposed successfully"))}}class pe{constructor(){l(this,"events",new Map)}on(s,e){const t=String(s);this.events.has(t)||this.events.set(t,[]),this.events.get(t).push(e)}off(s,e){const t=String(s),i=this.events.get(t);if(!i)return;const r=i.indexOf(e);r!==-1&&i.splice(r,1)}emit(s,e){const t=String(s),i=this.events.get(t);if(i)for(const r of i)try{r(e)}catch(n){console.error(`Error in event handler for ${t}:`,n)}}once(s,e){const t=i=>{this.off(s,t),e(i)};this.on(s,t)}clear(){this.events.clear()}}class j{constructor(s,e,t=100){l(this,"pool",[]);l(this,"factory");l(this,"reset");l(this,"maxSize");this.factory=s,this.reset=e,this.maxSize=t}acquire(){return this.pool.pop()||this.factory()}release(s){this.pool.length<this.maxSize&&(this.reset(s),this.pool.push(s))}clear(){this.pool.length=0}get size(){return this.pool.length}}function ke(h,s){let e=0;return(...t)=>{const i=Date.now();i-e>=s&&(e=i,h(...t))}}function Be(h,s){let e=null;return(...t)=>{e&&clearTimeout(e),e=window.setTimeout(()=>{h(...t)},s)}}class me{constructor(s){l(this,"lastCall",0);l(this,"frameInterval");this.frameInterval=1e3/s}canExecute(){const s=performance.now();return s-this.lastCall>=this.frameInterval?(this.lastCall=s,!0):!1}execute(s,...e){return this.canExecute()?s(...e):null}}class Fe{constructor(){l(this,"memoryHistory",[]);l(this,"maxHistoryLength",100)}getMemoryUsage(){return"memory"in performance?performance.memory.usedJSHeapSize/1024/1024:0}recordMemoryUsage(){const s=this.getMemoryUsage();this.memoryHistory.push(s),this.memoryHistory.length>this.maxHistoryLength&&this.memoryHistory.shift()}getMemoryTrend(){if(this.memoryHistory.length<10)return"stable";const s=this.memoryHistory.slice(-10),e=s.slice(0,5),t=s.slice(5),i=e.reduce((o,a)=>o+a,0)/e.length,n=t.reduce((o,a)=>o+a,0)/t.length-i;return n>1?"increasing":n<-1?"decreasing":"stable"}detectMemoryLeak(){const s=this.getMemoryTrend(),e=this.getMemoryUsage();return s==="increasing"&&e>100}}class ge{constructor(){l(this,"measurements",new Map);l(this,"startTimes",new Map)}start(s){this.startTimes.set(s,performance.now())}end(s){const e=this.startTimes.get(s);if(!e)return console.warn(`[PerformanceProfiler] No start time found for label: ${s}`),0;const t=performance.now()-e;return this.startTimes.delete(s),this.measurements.has(s)||this.measurements.set(s,[]),this.measurements.get(s).push(t),t}getResults(s){const e=this.measurements.get(s);if(!e||e.length===0)return null;const t=e.length,i=e.reduce((a,c)=>a+c,0),r=i/t,n=Math.min(...e),o=Math.max(...e);return{count:t,average:r,min:n,max:o,total:i}}clear(s){s?(this.measurements.delete(s),this.startTimes.delete(s)):(this.measurements.clear(),this.startTimes.clear())}getAllResults(){const s={};for(const[e]of this.measurements){const t=this.getResults(e);t&&(s[e]=t)}return s}}class be{constructor(){l(this,"pendingUpdates",new Map);l(this,"updateScheduled",!1)}scheduleUpdate(s,e){this.pendingUpdates.set(s,e),this.updateScheduled||(this.updateScheduled=!0,requestAnimationFrame(()=>{this.executeUpdates(),this.updateScheduled=!1}))}executeUpdates(){this.pendingUpdates.forEach(s=>{try{s()}catch(e){console.error("[BatchDOMUpdater] Update failed:",e)}}),this.pendingUpdates.clear()}cancelUpdate(s){this.pendingUpdates.delete(s)}clear(){this.pendingUpdates.clear(),this.updateScheduled=!1}}class Ue{constructor(s=100,e=6e4){l(this,"cache",new Map);l(this,"maxSize");l(this,"cleanupInterval",null);this.maxSize=s,this.cleanupInterval=window.setInterval(()=>{this.cleanup()},e)}set(s,e,t=3e5){if(this.cache.size>=this.maxSize){const i=this.cache.keys().next().value;i!==void 0&&this.cache.delete(i)}this.cache.set(s,{value:e,timestamp:Date.now(),ttl:t})}get(s){const e=this.cache.get(s);if(e){if(Date.now()-e.timestamp>e.ttl){this.cache.delete(s);return}return e.value}}delete(s){return this.cache.delete(s)}clear(){this.cache.clear()}cleanup(){const s=Date.now();for(const[e,t]of this.cache)s-t.timestamp>t.ttl&&this.cache.delete(e)}destroy(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.clear()}getStats(){return{size:this.cache.size,maxSize:this.maxSize,hitRate:0}}}class Ne{static isHighPerformanceDevice(){var s;return window.devicePixelRatio<=2&&navigator.hardwareConcurrency>=4&&!((s=navigator.connection)!=null&&s.saveData)}static getPerformanceLevel(){return this.isHighPerformanceDevice()?"high":window.devicePixelRatio<=2&&navigator.hardwareConcurrency>=2?"medium":"low"}static getOptimizationRecommendations(){const s=[];switch(this.getPerformanceLevel()){case"low":s.push("降低纹理质量"),s.push("减少后处理效果"),s.push("降低渲染分辨率"),s.push("禁用阴影");break;case"medium":s.push("适度降低纹理质量"),s.push("选择性启用后处理效果"),s.push("适度降低渲染分辨率");break;case"high":s.push("可启用高质量效果"),s.push("可使用高分辨率纹理"),s.push("可启用复杂后处理效果");break}return s}}const K=class K{constructor(){l(this,"frameRateLimiter");l(this,"isOptimizationEnabled",!1);this.frameRateLimiter=new me(60)}static getInstance(){return this.instance||(this.instance=new K),this.instance}enableOptimization(){this.isOptimizationEnabled=!0}disableOptimization(){this.isOptimizationEnabled=!1}optimizeRenderFunction(s,...e){return this.isOptimizationEnabled?this.frameRateLimiter.execute(s,...e):s(...e)}};l(K,"instance",null);let Q=K;class ye{constructor(s){l(this,"frameCount",0);l(this,"lastTime",0);l(this,"currentFps",0);l(this,"fpsHistory",[]);l(this,"historySize",60);l(this,"onFpsUpdate",null);l(this,"monitoring",!1);l(this,"frameId",0);s&&(this.onFpsUpdate=s)}start(){this.monitoring||(this.monitoring=!0,this.lastTime=performance.now(),this.frameId=requestAnimationFrame(this.update.bind(this)))}stop(){this.monitoring=!1,this.frameId&&cancelAnimationFrame(this.frameId)}update(s){if(!this.monitoring)return;this.frameCount++;const e=s-this.lastTime;e>=1e3&&(this.currentFps=Math.round(this.frameCount*1e3/e),this.fpsHistory.push(this.currentFps),this.fpsHistory.length>this.historySize&&this.fpsHistory.shift(),this.onFpsUpdate&&this.onFpsUpdate(this.currentFps),this.frameCount=0,this.lastTime=s),this.frameId=requestAnimationFrame(this.update.bind(this))}getCurrentFps(){return this.currentFps}getAverageFps(){if(this.fpsHistory.length===0)return 0;const s=this.fpsHistory.reduce((e,t)=>e+t,0);return Math.round(s/this.fpsHistory.length)}getFpsHistory(){return[...this.fpsHistory]}getFpsStats(){if(this.fpsHistory.length===0)return{current:this.currentFps,average:0,min:0,max:0};const s=Math.min(...this.fpsHistory),e=Math.max(...this.fpsHistory),t=this.getAverageFps();return{current:this.currentFps,average:t,min:s,max:e}}}class Se extends ge{constructor(){super(...arguments);l(this,"activeProfiles",new Set)}start(e){super.start(e),this.activeProfiles.add(e)}end(e){return this.activeProfiles.delete(e),super.end(e)}getActiveProfiles(){return Array.from(this.activeProfiles)}reset(){this.activeProfiles.clear(),this.clear()}}class Ge{static mergeGeometries(s){if(!s||s.length===0)return console.warn("[GeometryOptimizer] 没有提供几何体进行合并"),null;try{return console.warn("[GeometryOptimizer] BufferGeometryUtils未导入，无法合并几何体"),null}catch(e){return console.error("[GeometryOptimizer] 合并几何体失败:",e),null}}static optimizeGeometryAttributes(s){if(!s.attributes.position){console.warn("[GeometryOptimizer] 几何体缺少位置属性");return}s.boundingBox||s.computeBoundingBox(),s.boundingSphere||s.computeBoundingSphere(),s.index&&s.index.count>0&&console.log("[GeometryOptimizer] 几何体索引已存在，可考虑优化")}static simplifyGeometry(s,e=.5){return console.log(`[GeometryOptimizer] 简化几何体，目标比率: ${e}`),s}}class ve{static compressTexture(s,e=1024){if(!s.image)return console.warn("[TextureOptimizer] 纹理没有图像数据"),s;const t=s.image.width,i=s.image.height;if(t<=e&&i<=e)return s;const r=Math.min(e/t,e/i),n=Math.floor(t*r),o=Math.floor(i*r);return console.log(`[TextureOptimizer] 压缩纹理从 ${t}x${i} 到 ${n}x${o}`),s}static cacheTexture(s,e){this.textureCache.set(s,e),console.log(`[TextureOptimizer] 纹理已缓存: ${s}`)}static getCachedTexture(s){return this.textureCache.get(s)}static clearCache(){this.textureCache.clear(),console.log("[TextureOptimizer] 纹理缓存已清除")}}l(ve,"textureCache",new Map);class ze{constructor(s=100){l(this,"batches",new Map);l(this,"batchSize",100);this.batchSize=s}addObject(s,e){this.batches.has(s)||this.batches.set(s,[]);const t=this.batches.get(s);t.push(e),t.length>=this.batchSize&&(this.processBatch(s,t),t.length=0)}processBatch(s,e){console.log(`[RenderBatcher] 处理批次 ${s}，包含 ${e.length} 个对象`)}flush(){for(const[s,e]of this.batches)e.length>0&&(this.processBatch(s,e),e.length=0)}}class He extends A{constructor(e){super();l(this,"name","PerformanceAnalyzerScript");l(this,"frameCount",0);l(this,"lastAnalysisTime",0);l(this,"analysisInterval",1e3);l(this,"objectCounts",new Map);l(this,"memoryUsage",0);l(this,"lastMemoryCheck",0);l(this,"memoryCheckInterval",5e3);l(this,"drawCalls",0);l(this,"triangles",0);l(this,"points",0);l(this,"lines",0);l(this,"scriptExecutionTimes",new Map);l(this,"detailedAnalysis",!1);e&&(this.detailedAnalysis=e.detailedAnalysis??!1,this.analysisInterval=e.analysisInterval??1e3)}awake(){var e;(e=super.awake)==null||e.call(this)}onEnable(){var e;(e=super.onEnable)==null||e.call(this)}async start(){var e;(e=super.start)==null||e.call(this),this.lastAnalysisTime=performance.now()}update(e){var i;(i=super.update)==null||i.call(this,e),this.frameCount++;const t=performance.now();t-this.lastAnalysisTime>=this.analysisInterval&&(this.lastAnalysisTime=t),t-this.lastMemoryCheck>=this.memoryCheckInterval&&(this.checkMemoryUsage(),this.lastMemoryCheck=t)}countObjects(){if(this.objectCounts.clear(),!this.scene)return;const e=t=>{const i=t.type;this.objectCounts.set(i,(this.objectCounts.get(i)||0)+1),t.children.forEach(r=>e(r))};this.scene.children.forEach(t=>e(t))}checkMemoryUsage(){"memory"in performance&&(this.memoryUsage=performance.memory.usedJSHeapSize/1024/1024)}recordScriptExecution(e,t){this.scriptExecutionTimes.has(e)||this.scriptExecutionTimes.set(e,{total:0,count:0});const i=this.scriptExecutionTimes.get(e);i.total+=t,i.count++}resetStats(){this.frameCount=0,this.objectCounts.clear(),this.scriptExecutionTimes.clear()}getDetailedReport(){const e={timestamp:new Date().toISOString(),objectCounts:Object.fromEntries(this.objectCounts),memoryUsage:this.memoryUsage,scriptExecutionTimes:{}};for(const[t,i]of this.scriptExecutionTimes)e.scriptExecutionTimes[t]={averageTime:i.total/i.count,totalTime:i.total,callCount:i.count};if(this.renderer){const t=this.webGLRenderer.info;e.renderStats={drawCalls:t.render.calls,triangles:t.render.triangles,points:t.render.points,lines:t.render.lines,programs:t.programs?t.programs.length:0}}return e}destroy(){var e;(e=super.destroy)==null||e.call(this)}}class we{constructor(s){l(this,"renderer");l(this,"diagnostics",new Map);l(this,"isRunning",!1);l(this,"diagnosticInterval",1e3);l(this,"intervalId",null);this.renderer=s}start(){this.isRunning||(this.isRunning=!0,this.intervalId=window.setInterval(()=>{},this.diagnosticInterval))}stop(){this.isRunning&&(this.isRunning=!1,this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null))}getReport(){var e;const s={timestamp:new Date().toISOString(),basicPerformance:{},renderer:{},scene:{},scripts:{},memory:{},postProcessing:{}};if(this.renderer&&this.renderer.getPerformanceData){const t=this.renderer.getPerformanceData();t&&(s.basicPerformance=t.fpsStats)}if(this.renderer&&this.renderer.renderer){const t=this.renderer.renderer.info;s.renderer={drawCalls:t.render.calls,triangles:t.render.triangles,points:t.render.points,lines:t.render.lines,textures:t.textures,geometries:t.geometries,programs:((e=t.programs)==null?void 0:e.length)||0}}if(this.renderer&&this.renderer.scene){const t=this.renderer.scene;let i=0,r=0,n=0,o=0;const a=c=>{i++,c.isMesh&&r++,c.isLight&&n++,c.isCamera&&o++,c.children.forEach(d=>a(d))};t.children.forEach(c=>a(c)),s.scene={totalObjects:i,meshes:r,lights:n,cameras:o}}if(this.renderer&&this.renderer.scripts&&(s.scripts={count:this.renderer.scripts.length,types:this.renderer.scripts.map(t=>t.constructor.name)}),"memory"in performance){const t=performance.memory;s.memory={used:t.usedJSHeapSize,total:t.totalJSHeapSize,limit:t.jsHeapSizeLimit}}return s}generateOptimizationSuggestions(){const s=[];if(this.renderer){const e=this.renderer.getPerformanceData();if(e&&e.fpsStats.current<30&&s.push("⚠️ FPS过低，建议进行性能优化"),this.renderer.renderer&&this.renderer.renderer.info.render.calls>1e3&&s.push("⚠️ 绘制调用过多，建议合并几何体或使用实例化渲染"),this.renderer.scene){let t=0;const i=r=>{t++,r.children.forEach(n=>i(n))};this.renderer.scene.children.forEach(r=>i(r)),t>1e3&&s.push("⚠️ 场景对象过多，建议使用对象池或按需加载")}}return s.length===0&&s.push("✅ 当前性能状况良好"),s}}const Ve={isIphoneSafari(){if(typeof window>"u"||!window.navigator)return!1;const h=window.navigator.userAgent,s=/iPhone/i.test(h),e=/Safari/i.test(h)&&!/Chrome/i.test(h);return s&&e},isAndroid(){return typeof window>"u"||!window.navigator?!1:/Android/i.test(window.navigator.userAgent)},isIOS(){return typeof window>"u"||!window.navigator?!1:/iPad|iPhone|iPod/.test(window.navigator.userAgent)},isMobile(){return typeof window>"u"||!window.navigator?!1:this.isIOS()||this.isAndroid()},isDesktop(){return!this.isMobile()},getOSName(){if(typeof window>"u"||!window.navigator)return"unknown";const h=window.navigator.userAgent;return this.isIOS()?"iOS":this.isAndroid()?"Android":/Windows/i.test(h)?"Windows":/Mac/i.test(h)?"MacOS":/Linux/i.test(h)?"Linux":"unknown"},isSafari(){if(typeof window>"u"||!window.navigator)return!1;const h=window.navigator.userAgent;return/Safari/i.test(h)&&!/Chrome/i.test(h)},isChrome(){return typeof window>"u"||!window.navigator?!1:/Chrome/i.test(window.navigator.userAgent)},isFirefox(){return typeof window>"u"||!window.navigator?!1:/Firefox/i.test(window.navigator.userAgent)}};class Z extends A{constructor(e){super();l(this,"name","MouseInteractionScript");l(this,"config");l(this,"raycaster");l(this,"mouse");l(this,"hoveredObject",null);l(this,"selectedObjects",[]);l(this,"hoverTimeout",0);l(this,"onObjectSelectedCallbacks",[]);l(this,"onObjectHoveredCallbacks",[]);l(this,"onObjectDeselectedCallbacks",[]);l(this,"lastHoverCheck",0);l(this,"lastClickCheck",0);l(this,"vector2Pool");l(this,"intersectionPool");l(this,"raycastTimer",0);l(this,"throttledOnMouseMove",null);l(this,"onMouseMoveHandler",e=>{this.onMouseMove(e)});l(this,"onClickHandler",e=>{this.onClick(e)});l(this,"onTouchStartHandler",e=>{this.onTouchStart(e)});l(this,"onTouchMoveHandler",e=>{e.preventDefault()});l(this,"onTouchEndHandler",e=>{});this.config={interactionMode:"hover",enabled:!0,hoverDelay:0,showTooltip:!1,layerMask:4294967295,excludeObjects:[],excludeTypes:[],raycastInterval:16,...e},this.raycaster=new p.Raycaster,this.mouse=new p.Vector2,this.raycaster.params.Line={threshold:.01},this.raycaster.params.Points={threshold:.01},this.vector2Pool=new j(()=>new p.Vector2,t=>t.set(0,0)),this.intersectionPool=new j(()=>[],t=>t.length=0),this.throttledOnMouseMove=this.throttle(this.onMouseMove.bind(this),this.config.raycastInterval)}throttle(e,t){let i=0;return(...r)=>{const n=Date.now();n-i>=t&&(i=n,e(...r))}}async start(){var e;(e=super.start)==null||e.call(this),this.setupEventListeners()}update(e){var r;const t=performance.now();if((r=super.update)==null||r.call(this,e),!this.config.enabled)return;(this.config.interactionMode==="hover"||this.config.interactionMode==="both")&&this.handleMouseHover();const i=performance.now()-t;this.renderer&&this.renderer.performanceAnalyzer&&this.renderer.performanceAnalyzer.recordScriptExecution("MouseInteractionScript",i)}onResize(){super.onResize()}onDisable(){var e;(e=super.onDisable)==null||e.call(this),this.clearAllInteractions(),this.removeEventListeners()}destroy(){var e;(e=super.destroy)==null||e.call(this),this.removeEventListeners(),this.clearAllInteractions(),this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=0)}setOnObjectSelectedCallback(e){this.onObjectSelectedCallbacks=[e]}addOnObjectSelectedCallback(e){this.onObjectSelectedCallbacks.push(e)}removeOnObjectSelectedCallback(e){const t=this.onObjectSelectedCallbacks.indexOf(e);t>-1&&this.onObjectSelectedCallbacks.splice(t,1)}setOnObjectDeselectedCallback(e){this.onObjectDeselectedCallbacks=[e]}addOnObjectDeselectedCallback(e){this.onObjectDeselectedCallbacks.push(e)}removeOnObjectDeselectedCallback(e){const t=this.onObjectDeselectedCallbacks.indexOf(e);t>-1&&this.onObjectDeselectedCallbacks.splice(t,1)}setOnObjectHoveredCallback(e){this.onObjectHoveredCallbacks=[e]}addOnObjectHoveredCallback(e){this.onObjectHoveredCallbacks.push(e)}removeOnObjectHoveredCallback(e){const t=this.onObjectHoveredCallbacks.indexOf(e);t>-1&&this.onObjectHoveredCallbacks.splice(t,1)}setLayerMask(e){this.config.layerMask=e}addExcludedObject(e){this.config.excludeObjects.includes(e)||this.config.excludeObjects.push(e)}addExcludedObjects(e){for(const t of e)this.addExcludedObject(t)}removeExcludedObject(e){const t=this.config.excludeObjects.indexOf(e);t>-1&&this.config.excludeObjects.splice(t,1)}setExcludedTypes(e){this.config.excludeTypes=[...e]}isObjectInteractable(e){if(!e||!e.visible||e.layers&&!(e.layers.mask&this.config.layerMask)||this.config.excludeObjects.includes(e.name))return!1;const t=e.type;if(this.config.excludeTypes.includes(t))return!1;if(e instanceof p.Mesh){if(!e.material)return!1;if(Array.isArray(e.material)){for(const i of e.material)if(!i)return!1}}return!0}filterInteractableObjects(e){return e.filter(t=>t.object?this.isObjectInteractable(t.object):!1)}setupEventListeners(){try{const e=this.webGLRenderer.domElement;(this.config.interactionMode==="hover"||this.config.interactionMode==="both")&&this.throttledOnMouseMove&&e.addEventListener("mousemove",this.throttledOnMouseMove),(this.config.interactionMode==="click"||this.config.interactionMode==="both")&&(e.addEventListener("click",this.onClickHandler),e.addEventListener("touchstart",this.onTouchStartHandler)),e.addEventListener("touchmove",this.onTouchMoveHandler),e.addEventListener("touchend",this.onTouchEndHandler)}catch(e){console.error("[MouseInteractionScript] 设置事件监听器时出错:",e)}}removeEventListeners(){try{const e=this.webGLRenderer.domElement;this.throttledOnMouseMove&&e.removeEventListener("mousemove",this.throttledOnMouseMove),e.removeEventListener("click",this.onClickHandler),e.removeEventListener("touchstart",this.onTouchStartHandler),e.removeEventListener("touchmove",this.onTouchMoveHandler),e.removeEventListener("touchend",this.onTouchEndHandler)}catch(e){console.error("[MouseInteractionScript] 移除事件监听器时出错:",e)}}onMouseMove(e){try{const t=this.webGLRenderer.domElement.getBoundingClientRect(),i=this.vector2Pool.acquire();i.x=(e.clientX-t.left)/t.width*2-1,i.y=-((e.clientY-t.top)/t.height)*2+1,this.mouse.copy(i),this.vector2Pool.release(i)}catch(t){console.error("[MouseInteractionScript] 处理鼠标移动事件时出错:",t)}}onTouchStart(e){try{if(e&&typeof e.preventDefault=="function"&&e.preventDefault(),e.touches.length>0){const t=e.touches[0],i={clientX:t.clientX,clientY:t.clientY};this.onClick(i)}}catch(t){console.error("[MouseInteractionScript] 处理触摸事件时出错:",t)}}onClick(e){try{const t=performance.now();if(t-this.lastClickCheck<this.config.raycastInterval)return;this.lastClickCheck=t,e&&typeof e.preventDefault=="function"&&e.preventDefault();const r=this.webGLRenderer.domElement.getBoundingClientRect(),n=this.vector2Pool.acquire();n.x=(e.clientX-r.left)/r.width*2-1,n.y=-((e.clientY-r.top)/r.height)*2+1,this.raycaster.setFromCamera(n,this.camera);const o=this.intersectionPool.acquire();this.raycaster.intersectObjects(this.scene.children,!0,o);const a=this.filterInteractableObjects(o);if(a.length>0){const c=a[0].object;c&&c.isMesh&&this.selectObject(c)}else this.clearSelection();this.vector2Pool.release(n),this.intersectionPool.release(o)}catch(t){console.error("[MouseInteractionScript] 处理点击事件时出错:",t)}}handleMouseHover(){try{const e=performance.now();if(e-this.lastHoverCheck<this.config.raycastInterval)return;this.lastHoverCheck=e;const t=this.intersectionPool.acquire();this.raycaster.setFromCamera(this.mouse,this.camera),this.raycaster.intersectObjects(this.scene.children,!0,t);const i=this.filterInteractableObjects(t);if(i.length>0&&i[0].object.isMesh){const r=i[0].object;this.hoveredObject!==r&&this.hoverObject(r)}else this.hoveredObject&&this.clearHover();this.intersectionPool.release(t)}catch(e){console.error("[MouseInteractionScript] 处理鼠标悬停检测时出错:",e)}}hoverObject(e){try{this.clearHover(),this.hoveredObject=e;for(const t of this.onObjectHoveredCallbacks)t(e);this.config.hoverDelay>0&&(this.hoverTimeout=window.setTimeout(()=>{},this.config.hoverDelay))}catch(t){console.error("[MouseInteractionScript] 处理对象悬停时出错:",t)}}clearHover(){try{this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=0),this.hoveredObject=null;for(const e of this.onObjectHoveredCallbacks)e(null)}catch(e){console.error("[MouseInteractionScript] 清除悬停效果时出错:",e)}}selectObject(e){try{if(!e||!this.isObjectInteractable(e))return;let t=null;const i=this.selectedObjects.indexOf(e);i>-1?(this.selectedObjects.splice(i,1),t=e):this.selectedObjects.push(e);for(const r of this.onObjectSelectedCallbacks)r(t?null:e);if(t)for(const r of this.onObjectDeselectedCallbacks)r(t)}catch(t){console.error("[MouseInteractionScript] 处理对象选择时出错:",t)}}clearSelection(){try{const e=[...this.selectedObjects];this.selectedObjects=[];for(const t of e)for(const i of this.onObjectDeselectedCallbacks)i(t)}catch(e){console.error("[MouseInteractionScript] 清除选择时出错:",e)}}clearAllInteractions(){try{this.clearHover(),this.clearSelection()}catch(e){console.error("[MouseInteractionScript] 清除所有交互时出错:",e)}}getHoveredObject(){return this.hoveredObject}getSelectedObjects(){return[...this.selectedObjects]}setInteractionMode(e){try{this.config.interactionMode=e,this.throttledOnMouseMove=this.throttle(this.onMouseMove.bind(this),this.config.raycastInterval),this.removeEventListeners(),this.setupEventListeners()}catch(t){console.error("[MouseInteractionScript] 设置交互模式时出错:",t)}}setEnabled(e){try{this.config.enabled=e,e||this.clearAllInteractions()}catch(t){console.error("[MouseInteractionScript] 启用/禁用交互时出错:",t)}}getConfig(){return{...this.config}}updateConfig(e){try{const t=this.config.raycastInterval;this.config={...this.config,...e},e.raycastInterval!==void 0&&e.raycastInterval!==t&&(this.throttledOnMouseMove=this.throttle(this.onMouseMove.bind(this),this.config.raycastInterval))}catch(t){console.error("[MouseInteractionScript] 更新配置时出错:",t)}}}class We extends pe{constructor(e){super();l(this,"canvas");l(this,"config");l(this,"renderer");l(this,"scene");l(this,"camera");l(this,"mouseInteractionScript",null);l(this,"onObjectSelectedCallback",null);l(this,"onObjectHoveredCallback",null);l(this,"onObjectDeselectedCallback",null);l(this,"postProcessingComposer",null);l(this,"usePostProcessing",!1);l(this,"scripts",[]);l(this,"startedScripts",new Set);l(this,"isRendering",!1);l(this,"lastTime",0);l(this,"frameId",0);l(this,"frameCount",0);l(this,"lastFpsUpdate",0);l(this,"isHighPerformanceDeviceCached",null);l(this,"lastWidth",0);l(this,"lastHeight",0);l(this,"frameRateMonitor");l(this,"performanceProfiler");l(this,"lastFps",60);l(this,"targetFps",60);l(this,"frameInterval",1e3/60);l(this,"lastFrameTime",0);l(this,"skipRenderCount",0);l(this,"maxSkipFrames",2);l(this,"performanceAnalyzer",null);l(this,"fpsDiagnosticTool",null);l(this,"eventObjectPool");l(this,"fpsEventObjectPool");l(this,"performanceDropObjectPool");l(this,"batchDOMUpdater");l(this,"scriptMethodBatch",[]);l(this,"renderBatchSize",100);l(this,"objectUpdateQueue",[]);l(this,"onWindowResize");this.config=e,this.canvas=e.element,this.usePostProcessing=e.enablePostProcessing,this.renderer=new p.WebGLRenderer({canvas:this.canvas,antialias:this.config.antialias,alpha:this.config.alpha,powerPreference:"low-power",stencil:!0,depth:!0,logarithmicDepthBuffer:this.config.enableLogarithmicDepthBuffer??!0}),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=p.PCFSoftShadowMap,this.renderer.toneMapping=p.ACESFilmicToneMapping,this.renderer.toneMappingExposure=1,this.scene=new p.Scene,this.scene.background=e.backgroundColor?new p.Color(e.backgroundColor):null,this.camera=new p.PerspectiveCamera(75,this.config.aspect,.1,1e3),e.mouseInteraction&&(this.mouseInteractionScript=new Z(e.mouseInteraction),this.setupMouseInteractionCallbacks(),this.addScript(this.mouseInteractionScript)),this.usePostProcessing&&(this.postProcessingComposer=new fe(this)),this.updateRendererSize(),this.onWindowResize=this.handleWindowResize.bind(this),window.addEventListener("resize",this.onWindowResize),this.frameRateMonitor=new ye(t=>{const i=this.fpsEventObjectPool.acquire();if(i.fps=t,this.emit("performance:fps",i),this.fpsEventObjectPool.release(i),this.lastFps>30&&t<20){const r=this.performanceDropObjectPool.acquire();r.currentFps=t,r.previousFps=this.lastFps,this.emit("performance:drop",r),this.performanceDropObjectPool.release(r)}this.lastFps=t}),this.performanceProfiler=new Se,e.enablePerformanceMonitoring&&(this.performanceAnalyzer=new He({detailedAnalysis:!0,analysisInterval:1e3}),this.addScript(this.performanceAnalyzer)),e.enablePerformanceMonitoring&&(this.fpsDiagnosticTool=new we(this),this.fpsDiagnosticTool.start()),this.eventObjectPool=new j(()=>({deltaTime:0,timestamp:0}),t=>{t.deltaTime=0,t.timestamp=0},50),this.fpsEventObjectPool=new j(()=>({fps:0}),t=>{t.fps=0},50),this.performanceDropObjectPool=new j(()=>({currentFps:0,previousFps:0}),t=>{t.currentFps=0,t.previousFps=0},20),this.batchDOMUpdater=new be}isHighPerformanceDevice(){return this.isHighPerformanceDeviceCached!==null?this.isHighPerformanceDeviceCached:!0}updateRendererSize(){const e=window.innerWidth,t=window.innerHeight;if(this.lastWidth===e&&this.lastHeight===t)return;this.lastWidth=e,this.lastHeight=t,this.config.dpr.set(e,t),this.config.aspect=e/t,this.renderer.setSize(e,t);let i;this.isHighPerformanceDevice()?i=Math.min(2,window.devicePixelRatio):i=Math.min(1.5,window.devicePixelRatio),this.renderer.getPixelRatio()!==i&&this.renderer.setPixelRatio(i),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=p.PCFSoftShadowMap,this.renderer.toneMapping=p.ACESFilmicToneMapping,this.renderer.toneMappingExposure=.85,this.camera.aspect=this.config.aspect,this.camera.updateProjectionMatrix()}handleWindowResize(){this.updateRendererSize(),this.emit("scene:resize",{width:window.innerWidth,height:window.innerHeight})}start(){this.isRendering||(this.isRendering=!0,this.lastTime=performance.now(),this.lastFrameTime=this.lastTime,this.frameId=requestAnimationFrame(this.renderLoop.bind(this)),this.frameRateMonitor.start(),this.emit("render:start",{timestamp:this.lastTime}))}stop(){this.isRendering&&(this.isRendering=!1,this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=0),this.frameRateMonitor.stop(),this.emit("render:stop",{timestamp:performance.now()}))}renderLoop(e){if(!this.isRendering)return;if(e-this.lastFrameTime<this.frameInterval&&(this.skipRenderCount++,this.skipRenderCount<=this.maxSkipFrames)){this.frameId=requestAnimationFrame(this.renderLoop.bind(this));return}this.skipRenderCount=0,this.lastFrameTime=e;const i=Math.min((e-this.lastTime)/1e3,.016);this.lastTime=e,this.updateFpsCounter(e);const r=this.eventObjectPool.acquire();r.deltaTime=i,r.timestamp=e,this.emit("render:frame",r),this.eventObjectPool.release(r),this.performanceProfiler.start("frameRender"),this.fixedUpdate(1/60),this.callScriptMethodBatched("onPreRender"),this.updateScripts(i),this.callScriptMethodBatched("lateUpdate",i),this.batchRender(),this.callScriptMethodBatched("onPostRender"),this.performanceProfiler.end("frameRender"),this.batchDOMUpdater.scheduleUpdate("stats",()=>{}),this.frameId=requestAnimationFrame(this.renderLoop.bind(this))}updateFpsCounter(e){if(this.frameCount++,e-this.lastFpsUpdate>=1e3){const t=Math.round(this.frameCount*1e3/(e-this.lastFpsUpdate)),i=this.fpsEventObjectPool.acquire();i.fps=t,this.emit("performance:fps",i),this.fpsEventObjectPool.release(i),this.frameCount=0,this.lastFpsUpdate=e}}fixedUpdate(e){this.callScriptMethodBatched("fixedUpdate",e)}updateScripts(e){const t=[];for(const i of this.scripts){const r=i.start,n=i.update;if(!this.startedScripts.has(i)&&r)try{const o=r.call(i);o instanceof Promise?o.then(()=>{this.startedScripts.add(i)}).catch(a=>{console.error("Error in script start method:",a)}):this.startedScripts.add(i)}catch(o){console.error("Error in script start method:",o)}n&&this.startedScripts.has(i)&&t.push(i)}for(const i of t)try{this.performanceProfiler.start(`script:${i.name||"unnamed"}`),i.update.call(i,e),this.performanceProfiler.end(`script:${i.name||"unnamed"}`)}catch(r){console.error("Error in script update method:",r)}}callScriptMethodBatched(e,t){this.scriptMethodBatch.length=0;for(const i of this.scripts){const r=i[e];r&&typeof r=="function"&&this.scriptMethodBatch.push({script:i,method:e,arg:t})}for(const i of this.scriptMethodBatch)try{this.performanceProfiler.start(`script:${i.script.name||"unnamed"}:${i.method}`),i.arg!==void 0?i.script[i.method].call(i.script,i.arg):i.script[i.method].call(i.script),this.performanceProfiler.end(`script:${i.script.name||"unnamed"}:${i.method}`)}catch(r){console.error(`Error in script ${i.method} method:`,r)}}batchRender(){this.usePostProcessing&&this.postProcessingComposer?this.postProcessingComposer.render():this.renderer.render(this.scene,this.camera)}batchUpdateObjects(e,t,i){for(let r=0;r<e.length;r+=this.renderBatchSize){const n=e.slice(r,Math.min(r+this.renderBatchSize,e.length));requestAnimationFrame(()=>{for(const o of n)t(o,i)})}}queueObjectUpdate(e){this.objectUpdateQueue.push(e)}processObjectUpdateQueue(e,t){this.batchUpdateObjects(this.objectUpdateQueue,e,t),this.objectUpdateQueue.length=0}disableSelection(e){var t;(t=this.mouseInteractionScript)==null||t.addExcludedObject(e)}disableSelections(e){e.forEach(t=>{var i;(i=this.mouseInteractionScript)==null||i.addExcludedObject(t)})}addScript(e){if(e.host=this.scene,e instanceof A&&e.setRenderer(this),e.awake)try{e.awake.call(e)}catch(t){console.error("Error in script awake method:",t)}if(e.onEnable)try{e.onEnable.call(e)}catch(t){console.error("Error in script onEnable method:",t)}this.scripts.push(e),this.emit("script:added",{script:e})}removeScript(e){if(e.onDisable)try{e.onDisable.call(e)}catch(i){console.error("Error in script onDisable method:",i)}if(e.destroy)try{e.destroy.call(e)}catch(i){console.error("Error in script destroy method:",i)}this.startedScripts.delete(e);const t=this.scripts.indexOf(e);t!==-1&&this.scripts.splice(t,1),this.emit("script:removed",{script:e})}getSize(){return new p.Vector2(this.renderer.domElement.width,this.renderer.domElement.height)}setPixelRatio(e){this.renderer.setPixelRatio(e)}setSize(e){this.renderer.setSize(e.x,e.y)}resize(){this.handleWindowResize()}enablePostProcessing(){this.postProcessingComposer||(this.postProcessingComposer=new fe(this)),this.usePostProcessing=!0,this.postProcessingComposer.enable(),this.postProcessingComposer.setPixelRatio(window.devicePixelRatio),this.emit("postprocessing:enabled",{})}disablePostProcessing(){this.usePostProcessing=!1,this.postProcessingComposer&&this.postProcessingComposer.disable(),this.emit("postprocessing:disabled",{})}isPostProcessingEnabled(){return this.usePostProcessing&&this.postProcessingComposer!==null}getPostProcessingComposer(){return this.postProcessingComposer}addPostProcessingPass(e,t=!0){this.postProcessingComposer?this.postProcessingComposer.addPass(e,t):console.warn("[Aether3d] Post-processing composer not available. Enable post-processing first.")}removePostProcessingPass(e){this.postProcessingComposer&&this.postProcessingComposer.removePass(e)}dispose(){var e,t,i,r,n,o;this.stop(),window.removeEventListener("resize",this.onWindowResize);for(const a of this.scripts)this.removeScript(a);this.scripts=[],this.startedScripts.clear(),this.postProcessingComposer&&(this.postProcessingComposer.dispose(),this.postProcessingComposer=null),this.renderer.dispose(),this.clear(),this.performanceProfiler.reset(),(t=(e=this.eventObjectPool).clear)==null||t.call(e),(r=(i=this.fpsEventObjectPool).clear)==null||r.call(i),(o=(n=this.performanceDropObjectPool).clear)==null||o.call(n),this.batchDOMUpdater.clear(),this.objectUpdateQueue.length=0}getPerformanceData(){return{fpsStats:this.frameRateMonitor.getFpsStats(),profileData:this.performanceProfiler.getAllResults()}}setTargetFps(e){this.targetFps=e,this.frameInterval=1e3/e}setOnObjectSelectedCallback(e){this.onObjectSelectedCallback=e,this.mouseInteractionScript&&this.mouseInteractionScript.setOnObjectSelectedCallback(e)}setOnObjectDeselectedCallback(e){this.onObjectDeselectedCallback=e,this.mouseInteractionScript&&this.mouseInteractionScript.setOnObjectDeselectedCallback(e)}setOnObjectHoveredCallback(e){this.onObjectHoveredCallback=e,this.mouseInteractionScript&&this.mouseInteractionScript.setOnObjectHoveredCallback(e)}getMouseInteractionScript(){return this.mouseInteractionScript}setMouseInteractionConfig(e){this.mouseInteractionScript?this.mouseInteractionScript.updateConfig(e):(this.mouseInteractionScript=new Z(e),this.setupMouseInteractionCallbacks(),this.addScript(this.mouseInteractionScript))}runFPSDiagnostics(){return this.fpsDiagnosticTool?this.fpsDiagnosticTool.getReport():null}getOptimizationSuggestions(){return this.fpsDiagnosticTool?this.fpsDiagnosticTool.generateOptimizationSuggestions():[]}setupMouseInteractionCallbacks(){this.mouseInteractionScript&&(this.mouseInteractionScript.addOnObjectSelectedCallback(e=>{this.emit("mouse:objectSelected",{object:e}),this.onObjectSelectedCallback&&this.onObjectSelectedCallback(e)}),this.mouseInteractionScript.addOnObjectDeselectedCallback(e=>{this.emit("mouse:objectDeselected",{object:e}),this.onObjectDeselectedCallback&&this.onObjectDeselectedCallback(e)}),this.mouseInteractionScript.addOnObjectHoveredCallback(e=>{this.emit("mouse:objectHovered",{object:e}),this.onObjectHoveredCallback&&this.onObjectHoveredCallback(e)}))}}function Ke(h,s){const e=new p.PerspectiveCamera(75,s,.1,1e3);return e.name=h,e}class R{static addScene(s,e){if(this.scenes.has(e.name))throw new Error(`Scene '${e.name}' already exists`);this.scenes.set(e.name,e)}static getSceneData(s){if(!this.has(s)){const e=new p.Scene;e.name=s;const t={name:s,scene:e,camera:Ke(s+"Camera",window.innerWidth/window.innerHeight),scripts:[],objectScripts:new Map,startedScripts:new Set};return this.addScene(s,t),t}return this.scenes.get(s)}static getScene(s){if(!this.has(s))throw new Error(`Scene '${s}' not found`);return this.scenes.get(s).scene}static has(s){return this.scenes.has(s)}static setActive(s){if(!this.has(s))throw new Error(`Scene '${s}' not found`);return this.activeSceneName=s,L.sceneData=this.scenes.get(s),L.scene=L.sceneData.scene,L.camera=L.sceneData.camera,L.sceneData}static setActiveScene(s){if(s<0||s>=this.scenes.size)throw new Error(`Invalid scene index: ${s}`);return this.activeSceneName=Array.from(this.scenes.keys())[s],L.sceneData=Array.from(this.scenes.values())[s],L.scene=L.sceneData.scene,L.camera=L.sceneData.camera,L.sceneData}static removeScene(s){if(!this.has(s))throw new Error(`Scene '${s}' not found`);this.scenes.delete(s)}static destroy(){this.scenes.clear(),this.activeSceneName=""}}l(R,"scenes",new Map),l(R,"activeSceneName","");const L={renderer:null,scene:null,sceneData:null,camera:null,frame:0,frameId:0,contextLost:!1,enablePostProcessing:!1,composer:null,renderPass:null,outputPass:null};function qe(){return!!L.scene&&!!L.camera&&!!L.renderer}function Xe(h){if(R.has(h))return R.getScene(h);const s=new p.Scene;s.name=h;const e={name:h,scene:s,camera:Le(h+"Camera",window.innerWidth/window.innerHeight),scripts:[],objectScripts:new Map,startedScripts:new Set};return R.addScene(h,e),s}function $e(){!L.renderer||!L.scene||!L.camera||(L.enablePostProcessing&&L.composer?L.composer.render():L.renderer.render(L.scene,L.camera))}function Le(h,s){const e=new p.PerspectiveCamera(75,s,.1,1e3);return e.name=h,e}function Ye(){!L.renderer||!L.scene||!L.camera||(L.composer=new D.EffectComposer(L.renderer),L.renderPass=new q.RenderPass(L.scene,L.camera))}function Qe(){if(!L.renderer)return;const h=L.renderer.domElement;h.addEventListener("webglcontextlost",s=>{s.preventDefault(),L.contextLost=!0,console.warn("[WebGLRendererAdapter] WebGL context lost - 暂停渲染流程")},!1),h.addEventListener("webglcontextrestored",()=>{L.contextLost=!1,console.info("[WebGLRendererAdapter] WebGL context restored - 重新初始化资源")},!1)}function Ze(h,s,e){if(!R.has(h))throw new Error(`Scene '${h}' not found`);const t=R.getSceneData(h);if(s instanceof p.Object3D){if(!e)throw new Error("Script parameter is required when adding script to an object");t.objectScripts.has(s)||t.objectScripts.set(s,[]),t.objectScripts.get(s).push(e)}else t.scripts.push(s)}function Je(h,s,e){if(!R.has(h))throw new Error(`Scene '${h}' not found`);const t=R.getSceneData(h);if(s instanceof p.Object3D){if(!e)throw new Error("Script parameter is required when removing script from an object");if(!t.objectScripts.has(s))throw new Error("Object does not have any scripts");const i=t.objectScripts.get(s),r=i.indexOf(e);if(r===-1)throw new Error("Script not found on object");if(typeof e.destroy=="function")try{e.destroy()}catch(n){console.warn("Error during script destroy:",n)}i.splice(r,1),i.length===0&&t.objectScripts.delete(s)}else{const i=t.scripts.indexOf(s);if(i===-1)throw new Error("Script not found in scene");const r=t.scripts[i];if(typeof r.destroy=="function")try{r.destroy()}catch(n){console.warn("Error during script destroy:",n)}t.scripts.splice(i,1)}}class et extends A{constructor(e){super();l(this,"clipBias",.003);l(this,"textureWidth",1024);l(this,"textureHeight",1024);l(this,"color",8355711);l(this,"opacity",1);l(this,"blurStrength",0);l(this,"blurRadius",5);l(this,"gradientBlur",!1);l(this,"blurCenter",new p.Vector2(.5,.5));l(this,"reflector",null);l(this,"geometry",null);l(this,"reflectorObject",null);l(this,"blurRenderTarget1",null);l(this,"blurRenderTarget2",null);l(this,"blurPlane",null);l(this,"blurMaterial1",null);l(this,"blurMaterial2",null);l(this,"needsBlurUpdate",!1);this.name="MirrorReflectionScript",e&&(e.clipBias!==void 0&&(this.clipBias=e.clipBias),e.textureWidth!==void 0&&(this.textureWidth=e.textureWidth),e.textureHeight!==void 0&&(this.textureHeight=e.textureHeight),e.color!==void 0&&(this.color=e.color),e.opacity!==void 0&&(this.opacity=e.opacity),e.blurStrength!==void 0&&(this.blurStrength=e.blurStrength),e.blurRadius!==void 0&&(this.blurRadius=e.blurRadius),e.gradientBlur!==void 0&&(this.gradientBlur=e.gradientBlur),e.blurCenter!==void 0&&this.blurCenter.copy(e.blurCenter))}start(){}meshReflector(e){try{if(this.renderer&&(this.geometry=e,this.geometry)){if(this.reflector=new X.Reflector(this.geometry,{clipBias:this.clipBias,textureWidth:this.textureWidth,textureHeight:this.textureHeight,color:new p.Color(this.color)}),this.reflectorObject=this.reflector,this.reflectorObject.position.set(0,0,0),this.reflectorObject.visible=!0,this.reflectorObject.name="Reflection",this.reflectorObject&&this.reflectorObject.material){const t=this.reflectorObject.material;Array.isArray(t)?t.forEach(i=>{(i instanceof p.MeshBasicMaterial||i instanceof p.ShaderMaterial)&&(i.transparent=!0,i.opacity=this.opacity)}):(t instanceof p.MeshBasicMaterial||t instanceof p.ShaderMaterial)&&(t.transparent=!0,t.opacity=this.opacity)}this.scene&&this.scene.add(this.reflectorObject),console.log("[MirrorReflectionScript] Gradient blur mirror reflector created successfully")}}catch(t){console.error("[MirrorReflectionScript] Failed to create mirror reflector:",t)}}createReflector(){try{if(this.renderer&&(this.geometry=new p.PlaneGeometry(1e3,1e3),this.geometry)){if(this.reflector=new X.Reflector(this.geometry,{clipBias:this.clipBias,textureWidth:this.textureWidth,textureHeight:this.textureHeight,color:new p.Color(this.color)}),this.reflectorObject=this.reflector,this.reflectorObject.position.set(0,0,0),this.reflectorObject.rotation.x=-Math.PI/2,this.reflectorObject.visible=!0,this.reflectorObject.name="Reflection",this.reflectorObject&&this.reflectorObject.material){const e=this.reflectorObject.material;Array.isArray(e)?e.forEach(t=>{(t instanceof p.MeshBasicMaterial||t instanceof p.ShaderMaterial)&&(t.transparent=!0,t.opacity=this.opacity)}):(e instanceof p.MeshBasicMaterial||e instanceof p.ShaderMaterial)&&(e.transparent=!0,e.opacity=this.opacity)}this.scene&&this.scene.add(this.reflectorObject),console.log("[MirrorReflectionScript] Gradient blur mirror reflector created successfully")}}catch(e){console.error("[MirrorReflectionScript] Failed to create mirror reflector:",e)}}createBlurComponents(){if(!this.renderer)return;this.blurRenderTarget1=new p.WebGLRenderTarget(this.textureWidth,this.textureHeight),this.blurRenderTarget2=new p.WebGLRenderTarget(this.textureWidth,this.textureHeight),this.blurMaterial1=new p.ShaderMaterial({name:"HorizontalBlurMaterial",uniforms:{tDiffuse:{value:null},h:{value:this.blurRadius/this.textureWidth}},vertexShader:$.HorizontalBlurShader.vertexShader,fragmentShader:$.HorizontalBlurShader.fragmentShader}),this.blurMaterial2=new p.ShaderMaterial({name:"VerticalBlurMaterial",uniforms:{tDiffuse:{value:null},v:{value:this.blurRadius/this.textureHeight}},vertexShader:Y.VerticalBlurShader.vertexShader,fragmentShader:Y.VerticalBlurShader.fragmentShader});const e=new p.PlaneGeometry(2,2);this.blurPlane=new p.Mesh(e,this.blurMaterial1),this.blurPlane.visible=!1}applyBlur(e){if(!this.reflector||!this.blurRenderTarget1||!this.blurRenderTarget2||!this.blurMaterial1||!this.blurMaterial2||!this.blurPlane)return;if(this.blurStrength<=0){if(this.reflector.material){const i=this.reflector.material;i.uniforms&&i.uniforms.tDiffuse&&(i.uniforms.tDiffuse.value=this.reflector.getRenderTarget().texture)}return}const t=this.reflector.getRenderTarget().texture;if(this.blurMaterial1.uniforms.tDiffuse.value=t,this.blurMaterial1.uniforms.h.value=this.blurRadius/this.textureWidth*this.blurStrength,e.setRenderTarget(this.blurRenderTarget1),e.render(this.blurPlane,this.camera),this.blurMaterial2.uniforms.tDiffuse.value=this.blurRenderTarget1.texture,this.blurMaterial2.uniforms.v.value=this.blurRadius/this.textureHeight*this.blurStrength,e.setRenderTarget(this.blurRenderTarget2),e.render(this.blurPlane,this.camera),this.reflector.material){const i=this.reflector.material;i.uniforms&&i.uniforms.tDiffuse&&(i.uniforms.tDiffuse.value=this.blurRenderTarget2.texture)}this.needsBlurUpdate=!1}updateParameters(e){let t=!1;e.textureWidth!==void 0&&e.textureWidth!==this.textureWidth&&(this.textureWidth=e.textureWidth,t=!0),e.textureHeight!==void 0&&e.textureHeight!==this.textureHeight&&(this.textureHeight=e.textureHeight,t=!0),e.clipBias!==void 0&&(this.clipBias=e.clipBias),e.color!==void 0&&(this.color=e.color),e.opacity!==void 0&&(this.opacity=e.opacity),e.blurStrength!==void 0&&(this.blurStrength=e.blurStrength,this.needsBlurUpdate=!0),e.blurRadius!==void 0&&(this.blurRadius=e.blurRadius,this.needsBlurUpdate=!0),e.gradientBlur!==void 0&&(this.gradientBlur=e.gradientBlur),e.blurCenter!==void 0&&this.blurCenter.copy(e.blurCenter),t?(this.dispose(),this.createReflector(),this.createBlurComponents()):(this.updateReflectorParameters(),this.updateBlurParameters())}updateBlurParameters(){this.blurMaterial1&&this.blurMaterial2&&(this.blurMaterial1.uniforms.h.value=this.blurRadius/this.textureWidth*this.blurStrength,this.blurMaterial2.uniforms.v.value=this.blurRadius/this.textureHeight*this.blurStrength,this.needsBlurUpdate=!0)}updateReflectorParameters(){if(!this.reflectorObject||!this.reflectorObject.material)return;const e=this.reflectorObject.material;Array.isArray(e)?e.forEach(t=>{(t instanceof p.MeshBasicMaterial||t instanceof p.ShaderMaterial)&&(t.transparent=!0,t.opacity=this.opacity)}):(e instanceof p.MeshBasicMaterial||e instanceof p.ShaderMaterial)&&(e.transparent=!0,e.opacity=this.opacity)}setBlurStrength(e){this.blurStrength=Math.max(0,Math.min(1,e)),this.needsBlurUpdate=!0,this.updateBlurParameters(),console.log(`[MirrorReflectionScript] Blur strength set to: ${this.blurStrength}`)}setBlurRadius(e){this.blurRadius=Math.max(0,e),this.needsBlurUpdate=!0,this.updateBlurParameters(),console.log(`[MirrorReflectionScript] Blur radius set to: ${this.blurRadius}`)}setBlurCenter(e,t){this.blurCenter.set(e,t),console.log(`[MirrorReflectionScript] Blur center set to: (${e}, ${t})`)}setGradientBlurEnabled(e){this.gradientBlur=e,this.needsBlurUpdate=!0,console.log(`[MirrorReflectionScript] Gradient blur ${e?"enabled":"disabled"}`)}setOpacity(e){this.opacity=e,this.updateReflectorParameters()}setColor(e){if(this.color=e,this.reflector&&this.reflector.material){const t=this.reflector.material;!Array.isArray(t)&&t.uniforms&&t.uniforms.color&&(t.uniforms.color.value=new p.Color(e))}}getReflectorObject(){return this.reflectorObject}update(){}onPreRender(){this.renderer&&this.needsBlurUpdate&&this.applyBlur(this.renderer.renderer)}dispose(){this.reflectorObject&&this.scene&&this.scene.remove(this.reflectorObject),this.geometry&&this.geometry.dispose(),this.reflector&&typeof this.reflector.dispose=="function"&&this.reflector.dispose(),this.blurRenderTarget1&&this.blurRenderTarget1.dispose(),this.blurRenderTarget2&&this.blurRenderTarget2.dispose(),this.blurMaterial1&&this.blurMaterial1.dispose(),this.blurMaterial2&&this.blurMaterial2.dispose(),this.blurPlane&&this.blurPlane.geometry.dispose(),this.reflector=null,this.reflectorObject=null,this.geometry=null,this.blurRenderTarget1=null,this.blurRenderTarget2=null,this.blurPlane=null,this.blurMaterial1=null,this.blurMaterial2=null}}class tt extends A{constructor(e){super();l(this,"name","OrbitControlsScript");l(this,"config");l(this,"orbitControls",null);l(this,"cameraRef",null);l(this,"rendererRef",null);l(this,"_enabled",!0);l(this,"isAnimating",!1);l(this,"tween",null);l(this,"tweenBack",null);l(this,"lodPosition",null);l(this,"presets",{smooth:{enableDamping:!0,dampingFactor:.12,rotateSpeed:.3,panSpeed:1.5,zoomSpeed:.8},responsive:{enableDamping:!0,dampingFactor:.06,rotateSpeed:.5,panSpeed:2.5,zoomSpeed:1.2},presentation:{autoRotate:!0,autoRotateSpeed:1,enableDamping:!0,dampingFactor:.08,rotateSpeed:.4,panSpeed:1.8},cinema:{enableDamping:!0,dampingFactor:.15,rotateSpeed:.2,autoRotateSpeed:.5,minPolarAngle:Math.PI/6,maxPolarAngle:Math.PI*5/6,panSpeed:1.2},gaming:{enableDamping:!0,dampingFactor:.04,rotateSpeed:.8,panSpeed:3.5,zoomSpeed:1.5,autoRotateSpeed:2}});this.config={enableDamping:!0,dampingFactor:.08,enableZoom:!0,zoomSpeed:1,enablePan:!0,panSpeed:2,enableRotate:!0,rotateSpeed:.5,autoRotate:!1,autoRotateSpeed:2,minDistance:1,maxDistance:100,minPolarAngle:0,maxPolarAngle:Math.PI,minAzimuthAngle:-1/0,maxAzimuthAngle:1/0,target:new p.Vector3(0,0,0),...e}}onEnable(){var e;(e=super.onEnable)==null||e.call(this),this.orbitControls&&(this.orbitControls.enabled=!0)}async start(){var e;(e=super.start)==null||e.call(this);try{this.cameraRef=this.camera,this.rendererRef=this.webGLRenderer,!this.lodPosition&&this.cameraRef&&(this.lodPosition=this.cameraRef.position.clone())}catch(t){console.warn("[OrbitControlsScript] 无法直接获取相机或渲染器:",t)}!this.cameraRef||!this.rendererRef?console.warn("[OrbitControlsScript] 无法获取相机或渲染器，将在后续自动检测"):this.createOrbitControls()}update(e){var t,i,r;(t=super.update)==null||t.call(this,e),(!this.cameraRef||!this.rendererRef)&&this.tryAutoSetup(),this.orbitControls&&this._enabled&&this.orbitControls.update(),(i=this.tween)==null||i.update(),(r=this.tweenBack)==null||r.update()}onResize(){super.onResize()}onDisable(){var e;(e=super.onDisable)==null||e.call(this),this.orbitControls&&(this.orbitControls.enabled=!1)}destroy(){var e;(e=super.destroy)==null||e.call(this),this.stopAnimation(),this.orbitControls&&(this.orbitControls.dispose(),this.orbitControls=null)}tryAutoSetup(){try{this.cameraRef||(this.cameraRef=this.camera),this.rendererRef||(this.rendererRef=this.webGLRenderer),this.cameraRef&&this.rendererRef&&!this.orbitControls&&this.createOrbitControls()}catch(e){console.warn("[OrbitControlsScript] 自动设置相机和渲染器时出错:",e)}}createOrbitControls(){if(!this.cameraRef||!this.rendererRef){console.warn("[OrbitControlsScript] 相机或渲染器不可用");return}try{this.orbitControls&&this.orbitControls.dispose(),this.orbitControls=new de.OrbitControls(this.cameraRef,this.rendererRef.domElement),this.applyConfig()}catch(e){console.error("[OrbitControlsScript] 创建OrbitControls失败:",e)}}applyConfig(){if(!this.orbitControls)return;const e=this.orbitControls,t=this.config;e.enableDamping=t.enableDamping,e.dampingFactor=t.dampingFactor,e.enableZoom=t.enableZoom,e.zoomSpeed=t.zoomSpeed,e.enablePan=t.enablePan,e.panSpeed=t.panSpeed,e.enableRotate=t.enableRotate,e.rotateSpeed=t.rotateSpeed,e.autoRotate=t.autoRotate,e.autoRotateSpeed=t.autoRotateSpeed,e.minDistance=t.minDistance,e.maxDistance=t.maxDistance,e.minPolarAngle=t.minPolarAngle,e.maxPolarAngle=t.maxPolarAngle,e.minAzimuthAngle=t.minAzimuthAngle,e.maxAzimuthAngle=t.maxAzimuthAngle,e.target.copy(t.target),e.update()}stopAnimation(){this.tween&&(this.tween.stop(),this.tween=null),this.tweenBack&&(this.tweenBack.stop(),this.tweenBack=null),this.isAnimating=!1}animateToPosition(e,t,i){if(!this.cameraRef||!this.orbitControls)return;this.stopAnimation(),this.isAnimating=!0;const r=this.cameraRef.position.clone(),n=this.orbitControls.target.clone();this.tween=new E.Tween({x:r.x,y:r.y,z:r.z,targetX:n.x,targetY:n.y,targetZ:n.z}).to({x:e.x,y:e.y,z:e.z,targetX:t.x,targetY:t.y,targetZ:t.z},i.duration).easing(this.getTweenEasing(i.easing)).onUpdate(o=>{this.cameraRef.position.set(o.x,o.y,o.z),this.orbitControls.target.set(o.targetX,o.targetY,o.targetZ),this.orbitControls.update()}).onComplete(()=>{this.isAnimating=!1,this.config.target.copy(t),i.onComplete()}),this.tween.start()}getTweenEasing(e){switch(e){case"linear":return E.Easing.Linear.None;case"easeIn":return E.Easing.Quadratic.In;case"easeOut":return E.Easing.Quadratic.Out;case"easeInOut":return E.Easing.Quadratic.InOut;default:return E.Easing.Quadratic.InOut}}calculateBoundingBox(e){const t=new p.Box3;return e.traverse(i=>{if(i.isMesh){const r=i;if(r.geometry){r.updateWorldMatrix(!0,!1);const n=r.geometry;if(n.boundingBox)t.union(n.boundingBox.clone().applyMatrix4(r.matrixWorld));else{const o=new p.Box3().setFromObject(r);t.union(o)}}}}),t.isEmpty()&&t.setFromObject(e),t}enable(){this._enabled=!0,this.orbitControls&&(this.orbitControls.enabled=!0)}disable(){this._enabled=!1,this.orbitControls&&(this.orbitControls.enabled=!1)}reset(){this.orbitControls&&this.orbitControls.reset()}updateConfig(e){Object.assign(this.config,e),this.applyConfig()}getConfig(){return{...this.config}}applyPreset(e){const t=this.presets[e];t?this.updateConfig(t):console.warn(`[OrbitControlsScript] 未知的预设: ${e}`)}getPresets(){return Object.keys(this.presets)}backLodPosition(e,t){const i=e||this.lodPosition;if(i&&this.cameraRef&&this.orbitControls){const r={duration:1e3,distance:10,direction:new p.Vector3(1,1,1).normalize(),smooth:!0,easing:"easeInOut",onComplete:()=>{},mode:"center",offset:new p.Vector3(0,0,0),...t};this.stopAnimation(),this.isAnimating=!0;const n=this.cameraRef.position.clone(),o=this.orbitControls.target.clone(),a=i.clone(),c=new p.Vector3(0,0,0);this.tweenBack=new E.Tween({x:n.x,y:n.y,z:n.z,targetX:o.x,targetY:o.y,targetZ:o.z}).to({x:a.x,y:a.y,z:a.z,targetX:c.x,targetY:c.y,targetZ:c.z},r.duration).easing(this.getTweenEasing(r.easing)).onUpdate(d=>{this.cameraRef.position.set(d.x,d.y,d.z),this.orbitControls.target.set(d.targetX,d.targetY,d.targetZ),this.orbitControls.update()}).onComplete(()=>{var d;this.isAnimating=!1,this.config.target.copy(c),(d=r.onComplete)==null||d.call(r)}),this.tweenBack.start()}else console.warn("[OrbitControlsScript] 无法退回指定位置，缺少必要参数")}focusOnObject(e,t={}){if(!this.cameraRef||!this.orbitControls){console.warn("[OrbitControlsScript] 相机或控制器不可用");return}const r={...{duration:1e3,distance:10,direction:new p.Vector3(1,1,1).normalize(),smooth:!0,easing:"easeInOut",onComplete:()=>{},mode:"center",offset:new p.Vector3(0,0,0)},...t},n=this.calculateBoundingBox(e),o=n.getCenter(new p.Vector3),a=n.getSize(new p.Vector3);let c;const d=r.offset||new p.Vector3(0,0,0),u=Math.max(a.x,a.y,a.z),g=this.cameraRef.fov||50,m=u/(2*Math.tan(p.MathUtils.degToRad(g)/2))*1.5,y=r.distance===10?m:r.distance;switch(r.mode){case"front":c=o.clone().add(new p.Vector3(0,0,1).multiplyScalar(y)).add(d);break;case"back":c=o.clone().add(new p.Vector3(0,0,-1).multiplyScalar(y)).add(d);break;case"top":c=o.clone().add(new p.Vector3(0,1,0).multiplyScalar(y)).add(d);break;case"bottom":c=o.clone().add(new p.Vector3(0,-1,0).multiplyScalar(y)).add(d);break;case"left":c=o.clone().add(new p.Vector3(-1,0,0).multiplyScalar(y)).add(d);break;case"right":c=o.clone().add(new p.Vector3(1,0,0).multiplyScalar(y)).add(d);break;case"center":default:c=o.clone().add(r.direction.clone().multiplyScalar(y)).add(d);break}if(!r.smooth){this.cameraRef.position.copy(c),this.orbitControls.target.copy(o),this.orbitControls.update(),r.onComplete();return}this.animateToPosition(c,o,r)}getCameraPosition(){return this.cameraRef?this.cameraRef.position.clone():null}getTargetPosition(){return this.orbitControls?this.orbitControls.target.clone():null}getIsAnimating(){return this.isAnimating}getEnabled(){return this._enabled&&this.orbitControls!==null}getControls(){return this.orbitControls}setDefaultPosition(e){this.lodPosition=e.clone()}getDefaultPosition(){return this.lodPosition?this.lodPosition.clone():null}updateInitialPosition(){this.cameraRef&&(this.lodPosition=this.cameraRef.position.clone())}setDefaultCameraPosition(e,t){this.lodPosition=e.clone(),this.config.target=t.clone(),this.orbitControls&&(this.orbitControls.target.copy(t),this.orbitControls.update())}}class st extends A{constructor(e){super();l(this,"name","SceneLightingScript");l(this,"config");l(this,"ambientLight",null);l(this,"spotLight",null);l(this,"spotLightHelper",null);l(this,"textures",{none:null});l(this,"label",null);l(this,"labelElement",null);l(this,"isLightEnabled",!0);this.config={enableAmbientLight:!0,ambientLightColor:16777215,ambientLightGroundColor:9276813,ambientLightIntensity:4,enableSpotLight:!0,spotLightColor:16777215,spotLightIntensity:100,spotLightPosition:[2.5,5,2.5],spotLightTarget:[0,0,0],spotLightAngle:Math.PI/2,spotLightPenumbra:1,spotLightDecay:2,spotLightDistance:0,spotLightMap:"colors.jpg",spotLightShadow:{enabled:!0,mapSizeWidth:2024,mapSizeHeight:2024,cameraNear:1,cameraFar:0,focus:0},showLightHelpers:!0,showLabels:!0,labelContent:"灯光",clickableLabels:!0,...e}}start(){var e;(e=super.start)==null||e.call(this),this.loadTextures(),this.config.enableAmbientLight&&this.createAmbientLight(),this.config.enableSpotLight&&this.createSpotLight(),this.config.showLabels&&this.createLabel()}update(e){var t;(t=super.update)==null||t.call(this,e),this.spotLightHelper&&this.spotLightHelper.update(),this.label&&this.spotLight&&this.label.position.copy(this.spotLight.position)}loadTextures(){try{const e=new p.TextureLoader().setPath("/textures/"),t=["colors.png","disturb.jpg","uv_grid_opengl.jpg"];for(let i=0;i<t.length;i++){const r=t[i],n=e.load(r);n.minFilter=p.LinearFilter,n.magFilter=p.LinearFilter,n.generateMipmaps=!1,n.colorSpace=p.SRGBColorSpace,this.textures[r]=n}}catch(e){console.error("[SceneLightingScript] 加载纹理失败:",e)}}createAmbientLight(){try{this.scene&&(this.ambientLight=new p.HemisphereLight(this.config.ambientLightColor,this.config.ambientLightGroundColor,this.config.ambientLightIntensity),this.scene.add(this.ambientLight))}catch(e){console.error("[SceneLightingScript] 创建环境光失败:",e)}}createSpotLight(){var e;try{if(this.scene){this.spotLight=new p.SpotLight(this.config.spotLightColor,this.config.spotLightIntensity),this.spotLight.position.set(this.config.spotLightPosition[0],this.config.spotLightPosition[1],this.config.spotLightPosition[2]),this.spotLight.angle=this.config.spotLightAngle,this.spotLight.penumbra=this.config.spotLightPenumbra,this.spotLight.decay=this.config.spotLightDecay,this.spotLight.distance=this.config.spotLightDistance,this.config.spotLightMap&&this.textures[this.config.spotLightMap]&&(this.spotLight.map=this.textures[this.config.spotLightMap]),(e=this.config.spotLightShadow)!=null&&e.enabled&&(this.spotLight.castShadow=!0,this.spotLight.shadow.mapSize.width=this.config.spotLightShadow.mapSizeWidth||2024,this.spotLight.shadow.mapSize.height=this.config.spotLightShadow.mapSizeHeight||2024,this.spotLight.shadow.camera.near=this.config.spotLightShadow.cameraNear||1,this.spotLight.shadow.camera.far=this.config.spotLightShadow.cameraFar||0,this.spotLight.shadow.focus=this.config.spotLightShadow.focus||0);const t=new p.Object3D;t.position.set(this.config.spotLightTarget[0],this.config.spotLightTarget[1],this.config.spotLightTarget[2]),this.scene.add(t),this.spotLight.target=t,this.scene.add(this.spotLight),this.config.showLightHelpers&&this.spotLight&&(this.spotLightHelper=new p.SpotLightHelper(this.spotLight),this.scene.add(this.spotLightHelper))}}catch(t){console.error("[SceneLightingScript] 创建聚光灯失败:",t)}}createLabel(){try{this.spotLight&&this.scene&&(this.labelElement=document.createElement("div"),this.labelElement.className="scene-light-label",this.labelElement.textContent=this.config.labelContent||"灯光",this.labelElement.style.padding="8px 12px",this.labelElement.style.background="rgba(0, 0, 0, 0.85)",this.labelElement.style.color="#ffffff",this.labelElement.style.borderRadius="8px",this.labelElement.style.fontSize="14px",this.labelElement.style.fontFamily='Arial, "Microsoft YaHei", sans-serif',this.labelElement.style.fontWeight="500",this.labelElement.style.whiteSpace="nowrap",this.labelElement.style.userSelect="none",this.labelElement.style.border="1px solid rgba(255, 255, 255, 0.15)",this.labelElement.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.4)",this.labelElement.style.backdropFilter="blur(8px)",this.labelElement.style.pointerEvents=this.config.clickableLabels?"auto":"none",this.labelElement.style.zIndex="1000",this.labelElement.style.cursor=this.config.clickableLabels?"pointer":"default",this.config.clickableLabels&&(this.labelElement.addEventListener("mouseenter",()=>{this.labelElement.style.transform="scale(1.05)",this.labelElement.style.boxShadow="0 6px 16px rgba(0, 0, 0, 0.5)"}),this.labelElement.addEventListener("mouseleave",()=>{this.labelElement.style.transform="scale(1)",this.labelElement.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.4)"}),this.labelElement.addEventListener("click",e=>{e.stopPropagation(),this.toggleLight()})),this.label=new V.CSS2DObject(this.labelElement),this.label.position.copy(this.spotLight.position),this.scene.add(this.label))}catch(e){console.error("[SceneLightingScript] 创建标签失败:",e)}}updateAmbientLightConfig(e){this.ambientLight&&(e.color!==void 0&&this.ambientLight.color.set(e.color),e.groundColor!==void 0&&this.ambientLight.groundColor.set(e.groundColor),e.intensity!==void 0&&(this.ambientLight.intensity=e.intensity))}updateSpotLightTarget(e){this.spotLight&&this.spotLight.target.position.set(e[0],e[1],e[2])}updateSpotLightConfig(e){this.spotLight&&(e.color!==void 0&&this.spotLight.color.set(e.color),e.intensity!==void 0&&(this.spotLight.intensity=e.intensity),e.position!==void 0&&(this.spotLight.position.set(e.position[0],e.position[1],e.position[2]),this.label&&this.label.position.copy(this.spotLight.position)),e.target!==void 0&&this.spotLight.target.position.set(e.target[0],e.target[1],e.target[2]),e.angle!==void 0&&(this.spotLight.angle=e.angle),e.penumbra!==void 0&&(this.spotLight.penumbra=e.penumbra),e.decay!==void 0&&(this.spotLight.decay=e.decay),e.distance!==void 0&&(this.spotLight.distance=e.distance))}updateSpotLightShadowConfig(e){this.spotLight&&(e.enabled!==void 0&&(this.spotLight.castShadow=e.enabled),e.mapSizeWidth!==void 0&&(this.spotLight.shadow.mapSize.width=e.mapSizeWidth),e.mapSizeHeight!==void 0&&(this.spotLight.shadow.mapSize.height=e.mapSizeHeight),e.cameraNear!==void 0&&(this.spotLight.shadow.camera.near=e.cameraNear),e.cameraFar!==void 0&&(this.spotLight.shadow.camera.far=e.cameraFar),e.focus!==void 0&&(this.spotLight.shadow.focus=e.focus))}setLabelContent(e){this.config.labelContent=e,this.labelElement&&(this.labelElement.textContent=e)}setShowLabels(e){this.config.showLabels=e,this.label&&(this.label.visible=e)}setClickableLabels(e){this.config.clickableLabels=e,this.labelElement&&(this.labelElement.style.pointerEvents=e?"auto":"none",this.labelElement.style.cursor=e?"pointer":"default")}focusSpotLightOn(e){this.spotLight&&(this.spotLight.target=e,this.spotLightHelper&&this.spotLightHelper.update())}getSpotLight(){return this.spotLight}getSpotLightHelper(){return this.spotLightHelper}setAmbientLightEnabled(e){e&&!this.ambientLight?this.createAmbientLight():!e&&this.ambientLight&&(this.scene&&this.scene.remove(this.ambientLight),this.ambientLight=null)}setSpotLightEnabled(e){e&&!this.spotLight?this.createSpotLight():!e&&this.spotLight&&(this.scene&&(this.scene.remove(this.spotLight),this.spotLightHelper&&(this.scene.remove(this.spotLightHelper),this.spotLightHelper=null),this.label&&(this.scene.remove(this.label),this.label=null,this.labelElement=null)),this.spotLight=null),this.isLightEnabled=e,this.updateLabelStyle()}getAmbientLight(){return this.ambientLight}toggleLight(){this.isLightEnabled=!this.isLightEnabled,this.ambientLight&&(this.ambientLight.visible=this.isLightEnabled),this.spotLight&&(this.spotLight.visible=this.isLightEnabled,this.spotLight.intensity=this.isLightEnabled?this.config.spotLightIntensity:0),this.spotLightHelper&&(this.spotLightHelper.visible=this.isLightEnabled),this.updateLabelStyle(),console.log(`[SceneLightingScript] 灯光已${this.isLightEnabled?"开启":"关闭"}`)}updateLabelStyle(){this.labelElement&&(this.isLightEnabled?(this.labelElement.style.background="rgba(0, 0, 0, 0.85)",this.labelElement.style.border="1px solid rgba(255, 255, 255, 0.15)"):(this.labelElement.style.background="rgba(100, 100, 100, 0.85)",this.labelElement.style.border="1px solid rgba(150, 150, 150, 0.15)"))}destroy(){var e,t;(e=super.destroy)==null||e.call(this),this.ambientLight&&this.scene&&this.scene.remove(this.ambientLight),this.spotLight&&this.scene&&(this.spotLight.target&&this.spotLight.target!==this.scene&&this.scene.remove(this.spotLight.target),this.scene.remove(this.spotLight)),this.spotLightHelper&&this.scene&&this.scene.remove(this.spotLightHelper),this.label&&this.scene&&this.scene.remove(this.label);for(const i in this.textures)this.textures[i]&&((t=this.textures[i])==null||t.dispose());this.ambientLight=null,this.spotLight=null,this.spotLightHelper=null,this.label=null,this.labelElement=null,this.textures={none:null}}}class it extends A{constructor(e,t,i){super();l(this,"strength",.5);l(this,"radius",.4);l(this,"threshold",.85);l(this,"pass",null);this.name="BloomEffectScript",e!==void 0&&(this.strength=e),t!==void 0&&(this.radius=t),i!==void 0&&(this.threshold=i)}awake(){var e;(e=super.awake)==null||e.call(this),this.createPass()}onEnable(){var e;(e=super.onEnable)==null||e.call(this),this.pass&&this.renderer&&this.renderer.getPostProcessingComposer()&&(this.renderer.addPostProcessingPass(this.pass),console.log("[BloomEffectScript] Bloom pass enabled and added to composer"))}onDisable(){var e;(e=super.onDisable)==null||e.call(this),this.pass&&this.renderer&&(this.renderer.removePostProcessingPass(this.pass),console.log("[BloomEffectScript] Bloom pass disabled and removed from composer"))}destroy(){var e;(e=super.destroy)==null||e.call(this),this.pass&&this.renderer&&this.renderer.removePostProcessingPass(this.pass),this.pass&&typeof this.pass.dispose=="function"&&(this.pass.dispose(),this.pass=null),console.log("[BloomEffectScript] Bloom pass destroyed")}createPass(){try{if(this.renderer){const e=new p.Vector2(window.innerWidth,window.innerHeight);console.log("[BloomEffectScript] Creating Bloom pass with params:",{size:`${e.x}x${e.y}`,strength:this.strength,radius:this.radius,threshold:this.threshold}),this.pass=new ce.UnrealBloomPass(e,this.strength,this.radius,this.threshold),this.renderer.isPostProcessingEnabled()?(this.renderer.addPostProcessingPass(this.pass),console.log("[BloomEffectScript] Bloom pass created and added to composer")):console.log("[BloomEffectScript] Bloom pass created but post-processing is not enabled")}else console.warn("[BloomEffectScript] Renderer not available when creating Bloom pass")}catch(e){console.error("[BloomEffectScript] Failed to create Bloom pass:",e)}}updateParameters(e,t,i){e!==void 0&&(this.strength=e),t!==void 0&&(this.radius=t),i!==void 0&&(this.threshold=i),this.pass&&(e!==void 0&&(this.pass.strength=e),t!==void 0&&(this.pass.radius=t),i!==void 0&&(this.pass.threshold=i),console.log("[BloomEffectScript] Bloom parameters updated:",{strength:e!==void 0?e:this.strength,radius:t!==void 0?t:this.radius,threshold:i!==void 0?i:this.threshold}))}update(e){var t;(t=super.update)==null||t.call(this,e)}lateUpdate(e){var t;(t=super.lateUpdate)==null||t.call(this,e)}getPass(){return this.pass}}const z=class z extends A{constructor(e){super();l(this,"name","RectAreaLightScript");l(this,"config");l(this,"rectAreaLight",null);l(this,"rectAreaLightHelper",null);l(this,"label",null);l(this,"labelElement",null);l(this,"isLightEnabled",!0);l(this,"isTweenEnabled",!1);l(this,"openTweens",null);l(this,"closeTweens",null);this.config={enabled:!0,color:new p.Color("#6b828a"),intensity:1,width:10,height:10,position:[0,5,0],rotation:[0,0,0],showLightHelpers:!0,showLabels:!0,labelContent:"矩形区域光",clickableLabels:!0,...e},this.isLightEnabled=!1}start(){var e;(e=super.start)==null||e.call(this),z.uniformsLibInitialized||(le.RectAreaLightUniformsLib.init(),z.uniformsLibInitialized=!0),this.config.enabled&&(this.createRectAreaLight(),this.rectAreaLight&&(this.rectAreaLight.visible=!1,this.rectAreaLight.intensity=0)),this.config.showLabels&&(this.createLabel(),this.updateLabelStyle())}update(e){var t;(t=super.update)==null||t.call(this,e),this.label&&this.rectAreaLight&&this.label.position.copy(this.rectAreaLight.position)}createRectAreaLight(){try{this.scene&&(this.rectAreaLight=new p.RectAreaLight(this.config.color,this.config.intensity,this.config.width,this.config.height),this.rectAreaLight.position.set(this.config.position[0],this.config.position[1],this.config.position[2]),this.rectAreaLight.rotation.set(this.config.rotation[0],this.config.rotation[1],this.config.rotation[2]),this.scene.add(this.rectAreaLight),this.config.showLightHelpers&&this.rectAreaLight&&(this.rectAreaLightHelper=new he.RectAreaLightHelper(this.rectAreaLight),this.scene.add(this.rectAreaLightHelper)))}catch(e){console.error("[RectAreaLightScript] 创建矩形区域光失败:",e)}}createLabel(){try{if(this.rectAreaLight&&this.scene){this.labelElement=document.createElement("div"),this.labelElement.className="rect-area-light-label";const e=document.createElement("img");e.className="rect-area-light-icon",e.style.marginRight="6px",e.style.width="18px",e.style.height="18px",e.style.objectFit="contain";const t=document.createElement("span");t.className="rect-area-light-text",t.textContent=this.config.labelContent||"矩形区域光",this.labelElement.appendChild(e),this.labelElement.appendChild(t),this.labelElement.style.display="flex",this.labelElement.style.alignItems="center",this.labelElement.style.padding="6px 10px",this.labelElement.style.background="rgba(255, 255, 255, 0.05)",this.labelElement.style.color="#ffffff",this.labelElement.style.borderRadius="10px",this.labelElement.style.fontSize="12px",this.labelElement.style.fontFamily='Arial, "Microsoft YaHei", sans-serif',this.labelElement.style.fontWeight="500",this.labelElement.style.whiteSpace="nowrap",this.labelElement.style.userSelect="none",this.labelElement.style.border="1px solid rgba(255, 255, 255, 0.1)",this.labelElement.style.boxShadow=`
                    0 4px 30px rgba(0, 0, 0, 0.1),
                    inset 0 0 10px rgba(255, 255, 255, 0.1)
                `,this.labelElement.style.backdropFilter="blur(10px)",this.labelElement.style.webkitBackdropFilter="blur(10px)",this.labelElement.style.pointerEvents=this.config.clickableLabels?"auto":"none",this.labelElement.style.zIndex="1000",this.labelElement.style.cursor=this.config.clickableLabels?"pointer":"default",this.labelElement.style.position="relative",this.labelElement.style.overflow="hidden",this.labelElement.style.transition="all 0.1s ease",this.labelElement.style.opacity="1";const i=document.createElement("div");i.style.position="absolute",i.style.top="0",i.style.left="0",i.style.right="0",i.style.bottom="0",i.style.background="linear-gradient(45deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.01))",i.style.borderRadius="10px",i.style.zIndex="-1",i.style.pointerEvents="none",this.labelElement.appendChild(i);const r=document.createElement("div");r.style.position="absolute",r.style.top="0",r.style.left="0",r.style.right="0",r.style.bottom="0",r.style.background="radial-gradient(circle at center, rgba(255, 255, 255, 0.2) 0%, transparent 70%)",r.style.borderRadius="10px",r.style.zIndex="-1",r.style.pointerEvents="none",this.labelElement.appendChild(r),this.config.clickableLabels&&this.labelElement.addEventListener("click",n=>{n.stopPropagation(),this.toggleLight()}),this.label=new V.CSS2DObject(this.labelElement),this.label.position.copy(this.rectAreaLight.position),this.scene.add(this.label),this.updateLabelIcon()}}catch(e){console.error("[RectAreaLightScript] 创建标签失败:",e)}}updateConfig(e){this.rectAreaLight&&(e.color!==void 0&&this.rectAreaLight.color.set(e.color),e.intensity!==void 0&&(this.rectAreaLight.intensity=e.intensity),e.width!==void 0&&(this.rectAreaLight.width=e.width),e.height!==void 0&&(this.rectAreaLight.height=e.height),e.position!==void 0&&(this.rectAreaLight.position.set(e.position[0],e.position[1],e.position[2]),this.label&&this.label.position.copy(this.rectAreaLight.position)),e.rotation!==void 0&&this.rectAreaLight.rotation.set(e.rotation[0],e.rotation[1],e.rotation[2]))}setLabelContent(e){this.config.labelContent=e,this.labelElement&&(this.labelElement.textContent=e)}setShowLabels(e){this.config.showLabels=e,this.label&&this.labelElement?(this.labelElement.style.transition="opacity 0.3s ease-in-out",e?(this.label.visible=!0,requestAnimationFrame(()=>{this.labelElement.style.opacity="1"})):(this.labelElement.style.opacity="0",setTimeout(()=>{this.label&&(this.label.visible=!1)},300))):this.label&&(this.label.visible=e)}setClickableLabels(e){this.config.clickableLabels=e,this.labelElement&&(this.labelElement.style.pointerEvents=e?"auto":"none",this.labelElement.style.cursor=e?"pointer":"default")}getRectAreaLight(){return this.rectAreaLight}getRectAreaLightHelper(){return this.rectAreaLightHelper}setEnabled(e){e&&!this.rectAreaLight?this.createRectAreaLight():!e&&this.rectAreaLight&&(this.scene&&(this.scene.remove(this.rectAreaLight),this.rectAreaLightHelper&&(this.scene.remove(this.rectAreaLightHelper),this.rectAreaLightHelper=null),this.label&&(this.scene.remove(this.label),this.label=null,this.labelElement=null)),this.rectAreaLight=null),this.isLightEnabled=e,this.updateLabelStyle()}toggleLight(){this.isLightEnabled=!this.isLightEnabled,this.rectAreaLight&&(this.rectAreaLight.visible=this.isLightEnabled,this.rectAreaLight.intensity=this.isLightEnabled?this.config.intensity:0),this.rectAreaLightHelper&&(this.rectAreaLightHelper.visible=this.isLightEnabled),this.updateLabelStyle(),console.log(`[RectAreaLightScript] 矩形区域光已${this.isLightEnabled?"开启":"关闭"}`)}turnOn(){this.isLightEnabled||this.toggleLight()}turnOff(){this.isLightEnabled&&this.toggleLight()}isLightOn(){return this.isLightEnabled}updateLabelStyle(){this.labelElement&&(this.isLightEnabled?(this.labelElement.style.background="rgba(255, 255, 255, 0.08)",this.labelElement.style.border="1px solid rgba(255, 255, 255, 0.15)",this.labelElement.style.boxShadow=`
                    0 4px 30px rgba(0, 0, 0, 0.1),
                    inset 0 0 10px rgba(255, 255, 255, 0.1)
                `):(this.labelElement.style.background="rgba(100, 100, 100, 0.08)",this.labelElement.style.border="1px solid rgba(150, 150, 150, 0.15)",this.labelElement.style.boxShadow=`
                    0 4px 30px rgba(0, 0, 0, 0.1),
                    inset 0 0 10px rgba(150, 150, 150, 0.1)
                `),this.updateLabelIcon())}updateLabelIcon(){if(this.labelElement){const e=this.labelElement.querySelector(".rect-area-light-icon");e&&(this.isLightEnabled?e.src="https://lanhu-oss-2537-2.lanhuapp.com/FigmaDDSSlicePNG242ac23827c6159d8038b7d4dbbc8937.png":(e.src="https://lanhu-oss-2537-2.lanhuapp.com/FigmaDDSSlicePNG242ac23827c6159d8038b7d4dbbc8937.png",e.style.opacity="1"),this.isLightEnabled?e.style.opacity="1":e.style.opacity="0.5")}}destroy(){var e;(e=super.destroy)==null||e.call(this),this.rectAreaLight&&this.scene&&this.scene.remove(this.rectAreaLight),this.rectAreaLightHelper&&this.scene&&this.scene.remove(this.rectAreaLightHelper),this.label&&this.scene&&this.scene.remove(this.label),this.rectAreaLight=null,this.rectAreaLightHelper=null,this.label=null,this.labelElement=null}};l(z,"uniformsLibInitialized",!1);let J=z;function xe(h,s){if(s===f.TrianglesDrawMode)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),h;if(s===f.TriangleFanDrawMode||s===f.TriangleStripDrawMode){let e=h.getIndex();if(e===null){const n=[],o=h.getAttribute("position");if(o!==void 0){for(let a=0;a<o.count;a++)n.push(a);h.setIndex(n),e=h.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),h}const t=e.count-2,i=[];if(s===f.TriangleFanDrawMode)for(let n=1;n<=t;n++)i.push(e.getX(0)),i.push(e.getX(n)),i.push(e.getX(n+1));else for(let n=0;n<t;n++)n%2===0?(i.push(e.getX(n)),i.push(e.getX(n+1)),i.push(e.getX(n+2))):(i.push(e.getX(n+2)),i.push(e.getX(n+1)),i.push(e.getX(n)));i.length/3!==t&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=h.clone();return r.setIndex(i),r.clearGroups(),r}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",s),h}class rt extends f.Loader{constructor(s){super(s),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new lt(e)}),this.register(function(e){return new ht(e)}),this.register(function(e){return new St(e)}),this.register(function(e){return new vt(e)}),this.register(function(e){return new wt(e)}),this.register(function(e){return new ut(e)}),this.register(function(e){return new ft(e)}),this.register(function(e){return new pt(e)}),this.register(function(e){return new mt(e)}),this.register(function(e){return new ct(e)}),this.register(function(e){return new gt(e)}),this.register(function(e){return new dt(e)}),this.register(function(e){return new yt(e)}),this.register(function(e){return new bt(e)}),this.register(function(e){return new ot(e)}),this.register(function(e){return new Lt(e)}),this.register(function(e){return new xt(e)})}load(s,e,t,i){const r=this;let n;if(this.resourcePath!=="")n=this.resourcePath;else if(this.path!==""){const c=f.LoaderUtils.extractUrlBase(s);n=f.LoaderUtils.resolveURL(c,this.path)}else n=f.LoaderUtils.extractUrlBase(s);this.manager.itemStart(s);const o=function(c){i?i(c):console.error(c),r.manager.itemError(s),r.manager.itemEnd(s)},a=new f.FileLoader(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(s,function(c){try{r.parse(c,n,function(d){e(d),r.manager.itemEnd(s)},o)}catch(d){o(d)}},t,o)}setDRACOLoader(s){return this.dracoLoader=s,this}setKTX2Loader(s){return this.ktx2Loader=s,this}setMeshoptDecoder(s){return this.meshoptDecoder=s,this}register(s){return this.pluginCallbacks.indexOf(s)===-1&&this.pluginCallbacks.push(s),this}unregister(s){return this.pluginCallbacks.indexOf(s)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(s),1),this}parse(s,e,t,i){let r;const n={},o={},a=new TextDecoder;if(typeof s=="string")r=JSON.parse(s);else if(s instanceof ArrayBuffer)if(a.decode(new Uint8Array(s,0,4))===Me){try{n[x.KHR_BINARY_GLTF]=new Mt(s)}catch(u){i&&i(u);return}r=JSON.parse(n[x.KHR_BINARY_GLTF].content)}else r=JSON.parse(a.decode(s));else r=s;if(r.asset===void 0||r.asset.version[0]<2){i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new Bt(r,{path:e||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let d=0;d<this.pluginCallbacks.length;d++){const u=this.pluginCallbacks[d](c);u.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),o[u.name]=u,n[u.name]=!0}if(r.extensionsUsed)for(let d=0;d<r.extensionsUsed.length;++d){const u=r.extensionsUsed[d],g=r.extensionsRequired||[];switch(u){case x.KHR_MATERIALS_UNLIT:n[u]=new at;break;case x.KHR_DRACO_MESH_COMPRESSION:n[u]=new Ct(r,this.dracoLoader);break;case x.KHR_TEXTURE_TRANSFORM:n[u]=new Pt;break;case x.KHR_MESH_QUANTIZATION:n[u]=new At;break;default:g.indexOf(u)>=0&&o[u]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+u+'".')}}c.setExtensions(n),c.setPlugins(o),c.parse(t,i)}parseAsync(s,e){const t=this;return new Promise(function(i,r){t.parse(s,e,i,r)})}}function nt(){let h={};return{get:function(s){return h[s]},add:function(s,e){h[s]=e},remove:function(s){delete h[s]},removeAll:function(){h={}}}}const x={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class ot{constructor(s){this.parser=s,this.name=x.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const s=this.parser,e=this.parser.json.nodes||[];for(let t=0,i=e.length;t<i;t++){const r=e[t];r.extensions&&r.extensions[this.name]&&r.extensions[this.name].light!==void 0&&s._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(s){const e=this.parser,t="light:"+s;let i=e.cache.get(t);if(i)return i;const r=e.json,a=((r.extensions&&r.extensions[this.name]||{}).lights||[])[s];let c;const d=new f.Color(16777215);a.color!==void 0&&d.setRGB(a.color[0],a.color[1],a.color[2],f.LinearSRGBColorSpace);const u=a.range!==void 0?a.range:0;switch(a.type){case"directional":c=new f.DirectionalLight(d),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new f.PointLight(d),c.distance=u;break;case"spot":c=new f.SpotLight(d),c.distance=u,a.spot=a.spot||{},a.spot.innerConeAngle=a.spot.innerConeAngle!==void 0?a.spot.innerConeAngle:0,a.spot.outerConeAngle=a.spot.outerConeAngle!==void 0?a.spot.outerConeAngle:Math.PI/4,c.angle=a.spot.outerConeAngle,c.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return c.position.set(0,0,0),_(c,a),a.intensity!==void 0&&(c.intensity=a.intensity),c.name=e.createUniqueName(a.name||"light_"+s),i=Promise.resolve(c),e.cache.add(t,i),i}getDependency(s,e){if(s==="light")return this._loadLight(e)}createNodeAttachment(s){const e=this,t=this.parser,r=t.json.nodes[s],o=(r.extensions&&r.extensions[this.name]||{}).light;return o===void 0?null:this._loadLight(o).then(function(a){return t._getNodeRef(e.cache,o,a)})}}class at{constructor(){this.name=x.KHR_MATERIALS_UNLIT}getMaterialType(){return f.MeshBasicMaterial}extendParams(s,e,t){const i=[];s.color=new f.Color(1,1,1),s.opacity=1;const r=e.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const n=r.baseColorFactor;s.color.setRGB(n[0],n[1],n[2],f.LinearSRGBColorSpace),s.opacity=n[3]}r.baseColorTexture!==void 0&&i.push(t.assignTexture(s,"map",r.baseColorTexture,f.SRGBColorSpace))}return Promise.all(i)}}class ct{constructor(s){this.parser=s,this.name=x.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(s,e){const i=this.parser.json.materials[s];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=i.extensions[this.name].emissiveStrength;return r!==void 0&&(e.emissiveIntensity=r),Promise.resolve()}}class lt{constructor(s){this.parser=s,this.name=x.KHR_MATERIALS_CLEARCOAT}getMaterialType(s){const t=this.parser.json.materials[s];return!t.extensions||!t.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(s,e){const t=this.parser,i=t.json.materials[s];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];if(n.clearcoatFactor!==void 0&&(e.clearcoat=n.clearcoatFactor),n.clearcoatTexture!==void 0&&r.push(t.assignTexture(e,"clearcoatMap",n.clearcoatTexture)),n.clearcoatRoughnessFactor!==void 0&&(e.clearcoatRoughness=n.clearcoatRoughnessFactor),n.clearcoatRoughnessTexture!==void 0&&r.push(t.assignTexture(e,"clearcoatRoughnessMap",n.clearcoatRoughnessTexture)),n.clearcoatNormalTexture!==void 0&&(r.push(t.assignTexture(e,"clearcoatNormalMap",n.clearcoatNormalTexture)),n.clearcoatNormalTexture.scale!==void 0)){const o=n.clearcoatNormalTexture.scale;e.clearcoatNormalScale=new f.Vector2(o,o)}return Promise.all(r)}}class ht{constructor(s){this.parser=s,this.name=x.KHR_MATERIALS_DISPERSION}getMaterialType(s){const t=this.parser.json.materials[s];return!t.extensions||!t.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(s,e){const i=this.parser.json.materials[s];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=i.extensions[this.name];return e.dispersion=r.dispersion!==void 0?r.dispersion:0,Promise.resolve()}}class dt{constructor(s){this.parser=s,this.name=x.KHR_MATERIALS_IRIDESCENCE}getMaterialType(s){const t=this.parser.json.materials[s];return!t.extensions||!t.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(s,e){const t=this.parser,i=t.json.materials[s];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return n.iridescenceFactor!==void 0&&(e.iridescence=n.iridescenceFactor),n.iridescenceTexture!==void 0&&r.push(t.assignTexture(e,"iridescenceMap",n.iridescenceTexture)),n.iridescenceIor!==void 0&&(e.iridescenceIOR=n.iridescenceIor),e.iridescenceThicknessRange===void 0&&(e.iridescenceThicknessRange=[100,400]),n.iridescenceThicknessMinimum!==void 0&&(e.iridescenceThicknessRange[0]=n.iridescenceThicknessMinimum),n.iridescenceThicknessMaximum!==void 0&&(e.iridescenceThicknessRange[1]=n.iridescenceThicknessMaximum),n.iridescenceThicknessTexture!==void 0&&r.push(t.assignTexture(e,"iridescenceThicknessMap",n.iridescenceThicknessTexture)),Promise.all(r)}}class ut{constructor(s){this.parser=s,this.name=x.KHR_MATERIALS_SHEEN}getMaterialType(s){const t=this.parser.json.materials[s];return!t.extensions||!t.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(s,e){const t=this.parser,i=t.json.materials[s];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[];e.sheenColor=new f.Color(0,0,0),e.sheenRoughness=0,e.sheen=1;const n=i.extensions[this.name];if(n.sheenColorFactor!==void 0){const o=n.sheenColorFactor;e.sheenColor.setRGB(o[0],o[1],o[2],f.LinearSRGBColorSpace)}return n.sheenRoughnessFactor!==void 0&&(e.sheenRoughness=n.sheenRoughnessFactor),n.sheenColorTexture!==void 0&&r.push(t.assignTexture(e,"sheenColorMap",n.sheenColorTexture,f.SRGBColorSpace)),n.sheenRoughnessTexture!==void 0&&r.push(t.assignTexture(e,"sheenRoughnessMap",n.sheenRoughnessTexture)),Promise.all(r)}}class ft{constructor(s){this.parser=s,this.name=x.KHR_MATERIALS_TRANSMISSION}getMaterialType(s){const t=this.parser.json.materials[s];return!t.extensions||!t.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(s,e){const t=this.parser,i=t.json.materials[s];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return n.transmissionFactor!==void 0&&(e.transmission=n.transmissionFactor),n.transmissionTexture!==void 0&&r.push(t.assignTexture(e,"transmissionMap",n.transmissionTexture)),Promise.all(r)}}class pt{constructor(s){this.parser=s,this.name=x.KHR_MATERIALS_VOLUME}getMaterialType(s){const t=this.parser.json.materials[s];return!t.extensions||!t.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(s,e){const t=this.parser,i=t.json.materials[s];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];e.thickness=n.thicknessFactor!==void 0?n.thicknessFactor:0,n.thicknessTexture!==void 0&&r.push(t.assignTexture(e,"thicknessMap",n.thicknessTexture)),e.attenuationDistance=n.attenuationDistance||1/0;const o=n.attenuationColor||[1,1,1];return e.attenuationColor=new f.Color().setRGB(o[0],o[1],o[2],f.LinearSRGBColorSpace),Promise.all(r)}}class mt{constructor(s){this.parser=s,this.name=x.KHR_MATERIALS_IOR}getMaterialType(s){const t=this.parser.json.materials[s];return!t.extensions||!t.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(s,e){const i=this.parser.json.materials[s];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=i.extensions[this.name];return e.ior=r.ior!==void 0?r.ior:1.5,Promise.resolve()}}class gt{constructor(s){this.parser=s,this.name=x.KHR_MATERIALS_SPECULAR}getMaterialType(s){const t=this.parser.json.materials[s];return!t.extensions||!t.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(s,e){const t=this.parser,i=t.json.materials[s];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];e.specularIntensity=n.specularFactor!==void 0?n.specularFactor:1,n.specularTexture!==void 0&&r.push(t.assignTexture(e,"specularIntensityMap",n.specularTexture));const o=n.specularColorFactor||[1,1,1];return e.specularColor=new f.Color().setRGB(o[0],o[1],o[2],f.LinearSRGBColorSpace),n.specularColorTexture!==void 0&&r.push(t.assignTexture(e,"specularColorMap",n.specularColorTexture,f.SRGBColorSpace)),Promise.all(r)}}class bt{constructor(s){this.parser=s,this.name=x.EXT_MATERIALS_BUMP}getMaterialType(s){const t=this.parser.json.materials[s];return!t.extensions||!t.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(s,e){const t=this.parser,i=t.json.materials[s];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return e.bumpScale=n.bumpFactor!==void 0?n.bumpFactor:1,n.bumpTexture!==void 0&&r.push(t.assignTexture(e,"bumpMap",n.bumpTexture)),Promise.all(r)}}class yt{constructor(s){this.parser=s,this.name=x.KHR_MATERIALS_ANISOTROPY}getMaterialType(s){const t=this.parser.json.materials[s];return!t.extensions||!t.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(s,e){const t=this.parser,i=t.json.materials[s];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return n.anisotropyStrength!==void 0&&(e.anisotropy=n.anisotropyStrength),n.anisotropyRotation!==void 0&&(e.anisotropyRotation=n.anisotropyRotation),n.anisotropyTexture!==void 0&&r.push(t.assignTexture(e,"anisotropyMap",n.anisotropyTexture)),Promise.all(r)}}class St{constructor(s){this.parser=s,this.name=x.KHR_TEXTURE_BASISU}loadTexture(s){const e=this.parser,t=e.json,i=t.textures[s];if(!i.extensions||!i.extensions[this.name])return null;const r=i.extensions[this.name],n=e.options.ktx2Loader;if(!n){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return e.loadTextureImage(s,r.source,n)}}class vt{constructor(s){this.parser=s,this.name=x.EXT_TEXTURE_WEBP}loadTexture(s){const e=this.name,t=this.parser,i=t.json,r=i.textures[s];if(!r.extensions||!r.extensions[e])return null;const n=r.extensions[e],o=i.images[n.source];let a=t.textureLoader;if(o.uri){const c=t.options.manager.getHandler(o.uri);c!==null&&(a=c)}return t.loadTextureImage(s,n.source,a)}}class wt{constructor(s){this.parser=s,this.name=x.EXT_TEXTURE_AVIF}loadTexture(s){const e=this.name,t=this.parser,i=t.json,r=i.textures[s];if(!r.extensions||!r.extensions[e])return null;const n=r.extensions[e],o=i.images[n.source];let a=t.textureLoader;if(o.uri){const c=t.options.manager.getHandler(o.uri);c!==null&&(a=c)}return t.loadTextureImage(s,n.source,a)}}class Lt{constructor(s){this.name=x.EXT_MESHOPT_COMPRESSION,this.parser=s}loadBufferView(s){const e=this.parser.json,t=e.bufferViews[s];if(t.extensions&&t.extensions[this.name]){const i=t.extensions[this.name],r=this.parser.getDependency("buffer",i.buffer),n=this.parser.options.meshoptDecoder;if(!n||!n.supported){if(e.extensionsRequired&&e.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then(function(o){const a=i.byteOffset||0,c=i.byteLength||0,d=i.count,u=i.byteStride,g=new Uint8Array(o,a,c);return n.decodeGltfBufferAsync?n.decodeGltfBufferAsync(d,u,g,i.mode,i.filter).then(function(m){return m.buffer}):n.ready.then(function(){const m=new ArrayBuffer(d*u);return n.decodeGltfBuffer(new Uint8Array(m),d,u,g,i.mode,i.filter),m})})}else return null}}class xt{constructor(s){this.name=x.EXT_MESH_GPU_INSTANCING,this.parser=s}createNodeMesh(s){const e=this.parser.json,t=e.nodes[s];if(!t.extensions||!t.extensions[this.name]||t.mesh===void 0)return null;const i=e.meshes[t.mesh];for(const c of i.primitives)if(c.mode!==T.TRIANGLES&&c.mode!==T.TRIANGLE_STRIP&&c.mode!==T.TRIANGLE_FAN&&c.mode!==void 0)return null;const n=t.extensions[this.name].attributes,o=[],a={};for(const c in n)o.push(this.parser.getDependency("accessor",n[c]).then(d=>(a[c]=d,a[c])));return o.length<1?null:(o.push(this.parser.createNodeMesh(s)),Promise.all(o).then(c=>{const d=c.pop(),u=d.isGroup?d.children:[d],g=c[0].count,m=[];for(const y of u){const v=new f.Matrix4,S=new f.Vector3,w=new f.Quaternion,M=new f.Vector3(1,1,1),P=new f.InstancedMesh(y.geometry,y.material,g);for(let C=0;C<g;C++)a.TRANSLATION&&S.fromBufferAttribute(a.TRANSLATION,C),a.ROTATION&&w.fromBufferAttribute(a.ROTATION,C),a.SCALE&&M.fromBufferAttribute(a.SCALE,C),P.setMatrixAt(C,v.compose(S,w,M));for(const C in a)if(C==="_COLOR_0"){const I=a[C];P.instanceColor=new f.InstancedBufferAttribute(I.array,I.itemSize,I.normalized)}else C!=="TRANSLATION"&&C!=="ROTATION"&&C!=="SCALE"&&y.geometry.setAttribute(C,a[C]);f.Object3D.prototype.copy.call(P,y),this.parser.assignFinalMaterial(P),m.push(P)}return d.isGroup?(d.clear(),d.add(...m),d):m[0]}))}}const Me="glTF",G=12,Ce={JSON:1313821514,BIN:5130562};class Mt{constructor(s){this.name=x.KHR_BINARY_GLTF,this.content=null,this.body=null;const e=new DataView(s,0,G),t=new TextDecoder;if(this.header={magic:t.decode(new Uint8Array(s.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0)},this.header.magic!==Me)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-G,r=new DataView(s,G);let n=0;for(;n<i;){const o=r.getUint32(n,!0);n+=4;const a=r.getUint32(n,!0);if(n+=4,a===Ce.JSON){const c=new Uint8Array(s,G+n,o);this.content=t.decode(c)}else if(a===Ce.BIN){const c=G+n;this.body=s.slice(c,c+o)}n+=o}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Ct{constructor(s,e){if(!e)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=x.KHR_DRACO_MESH_COMPRESSION,this.json=s,this.dracoLoader=e,this.dracoLoader.preload()}decodePrimitive(s,e){const t=this.json,i=this.dracoLoader,r=s.extensions[this.name].bufferView,n=s.extensions[this.name].attributes,o={},a={},c={};for(const d in n){const u=te[d]||d.toLowerCase();o[u]=n[d]}for(const d in s.attributes){const u=te[d]||d.toLowerCase();if(n[d]!==void 0){const g=t.accessors[s.attributes[d]],m=N[g.componentType];c[u]=m.name,a[u]=g.normalized===!0}}return e.getDependency("bufferView",r).then(function(d){return new Promise(function(u,g){i.decodeDracoFile(d,function(m){for(const y in m.attributes){const v=m.attributes[y],S=a[y];S!==void 0&&(v.normalized=S)}u(m)},o,c,f.LinearSRGBColorSpace,g)})})}}class Pt{constructor(){this.name=x.KHR_TEXTURE_TRANSFORM}extendTexture(s,e){return(e.texCoord===void 0||e.texCoord===s.channel)&&e.offset===void 0&&e.rotation===void 0&&e.scale===void 0||(s=s.clone(),e.texCoord!==void 0&&(s.channel=e.texCoord),e.offset!==void 0&&s.offset.fromArray(e.offset),e.rotation!==void 0&&(s.rotation=e.rotation),e.scale!==void 0&&s.repeat.fromArray(e.scale),s.needsUpdate=!0),s}}class At{constructor(){this.name=x.KHR_MESH_QUANTIZATION}}class Pe extends f.Interpolant{constructor(s,e,t,i){super(s,e,t,i)}copySampleValue_(s){const e=this.resultBuffer,t=this.sampleValues,i=this.valueSize,r=s*i*3+i;for(let n=0;n!==i;n++)e[n]=t[r+n];return e}interpolate_(s,e,t,i){const r=this.resultBuffer,n=this.sampleValues,o=this.valueSize,a=o*2,c=o*3,d=i-e,u=(t-e)/d,g=u*u,m=g*u,y=s*c,v=y-c,S=-2*m+3*g,w=m-g,M=1-S,P=w-g+u;for(let C=0;C!==o;C++){const I=n[v+C+o],B=n[v+C+a]*d,O=n[y+C+o],H=n[y+C]*d;r[C]=M*I+P*B+S*O+w*H}return r}}const Tt=new f.Quaternion;class Ot extends Pe{interpolate_(s,e,t,i){const r=super.interpolate_(s,e,t,i);return Tt.fromArray(r).normalize().toArray(r),r}}const T={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},N={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Ae={9728:f.NearestFilter,9729:f.LinearFilter,9984:f.NearestMipmapNearestFilter,9985:f.LinearMipmapNearestFilter,9986:f.NearestMipmapLinearFilter,9987:f.LinearMipmapLinearFilter},Te={33071:f.ClampToEdgeWrapping,33648:f.MirroredRepeatWrapping,10497:f.RepeatWrapping},ee={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},te={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},k={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Rt={CUBICSPLINE:void 0,LINEAR:f.InterpolateLinear,STEP:f.InterpolateDiscrete},se={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function It(h){return h.DefaultMaterial===void 0&&(h.DefaultMaterial=new f.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:f.FrontSide})),h.DefaultMaterial}function U(h,s,e){for(const t in e.extensions)h[t]===void 0&&(s.userData.gltfExtensions=s.userData.gltfExtensions||{},s.userData.gltfExtensions[t]=e.extensions[t])}function _(h,s){s.extras!==void 0&&(typeof s.extras=="object"?Object.assign(h.userData,s.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+s.extras))}function _t(h,s,e){let t=!1,i=!1,r=!1;for(let c=0,d=s.length;c<d;c++){const u=s[c];if(u.POSITION!==void 0&&(t=!0),u.NORMAL!==void 0&&(i=!0),u.COLOR_0!==void 0&&(r=!0),t&&i&&r)break}if(!t&&!i&&!r)return Promise.resolve(h);const n=[],o=[],a=[];for(let c=0,d=s.length;c<d;c++){const u=s[c];if(t){const g=u.POSITION!==void 0?e.getDependency("accessor",u.POSITION):h.attributes.position;n.push(g)}if(i){const g=u.NORMAL!==void 0?e.getDependency("accessor",u.NORMAL):h.attributes.normal;o.push(g)}if(r){const g=u.COLOR_0!==void 0?e.getDependency("accessor",u.COLOR_0):h.attributes.color;a.push(g)}}return Promise.all([Promise.all(n),Promise.all(o),Promise.all(a)]).then(function(c){const d=c[0],u=c[1],g=c[2];return t&&(h.morphAttributes.position=d),i&&(h.morphAttributes.normal=u),r&&(h.morphAttributes.color=g),h.morphTargetsRelative=!0,h})}function Dt(h,s){if(h.updateMorphTargets(),s.weights!==void 0)for(let e=0,t=s.weights.length;e<t;e++)h.morphTargetInfluences[e]=s.weights[e];if(s.extras&&Array.isArray(s.extras.targetNames)){const e=s.extras.targetNames;if(h.morphTargetInfluences.length===e.length){h.morphTargetDictionary={};for(let t=0,i=e.length;t<i;t++)h.morphTargetDictionary[e[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Et(h){let s;const e=h.extensions&&h.extensions[x.KHR_DRACO_MESH_COMPRESSION];if(e?s="draco:"+e.bufferView+":"+e.indices+":"+ie(e.attributes):s=h.indices+":"+ie(h.attributes)+":"+h.mode,h.targets!==void 0)for(let t=0,i=h.targets.length;t<i;t++)s+=":"+ie(h.targets[t]);return s}function ie(h){let s="";const e=Object.keys(h).sort();for(let t=0,i=e.length;t<i;t++)s+=e[t]+":"+h[e[t]]+";";return s}function re(h){switch(h){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function jt(h){return h.search(/\.jpe?g($|\?)/i)>0||h.search(/^data\:image\/jpeg/)===0?"image/jpeg":h.search(/\.webp($|\?)/i)>0||h.search(/^data\:image\/webp/)===0?"image/webp":h.search(/\.ktx2($|\?)/i)>0||h.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const kt=new f.Matrix4;class Bt{constructor(s={},e={}){this.json=s,this.extensions={},this.plugins={},this.options=e,this.cache=new nt,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let t=!1,i=-1,r=!1,n=-1;if(typeof navigator<"u"){const o=navigator.userAgent;t=/^((?!chrome|android).)*safari/i.test(o)===!0;const a=o.match(/Version\/(\d+)/);i=t&&a?parseInt(a[1],10):-1,r=o.indexOf("Firefox")>-1,n=r?o.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||t&&i<17||r&&n<98?this.textureLoader=new f.TextureLoader(this.options.manager):this.textureLoader=new f.ImageBitmapLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new f.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(s){this.extensions=s}setPlugins(s){this.plugins=s}parse(s,e){const t=this,i=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(n){return n._markDefs&&n._markDefs()}),Promise.all(this._invokeAll(function(n){return n.beforeRoot&&n.beforeRoot()})).then(function(){return Promise.all([t.getDependencies("scene"),t.getDependencies("animation"),t.getDependencies("camera")])}).then(function(n){const o={scene:n[0][i.scene||0],scenes:n[0],animations:n[1],cameras:n[2],asset:i.asset,parser:t,userData:{}};return U(r,o,i),_(o,i),Promise.all(t._invokeAll(function(a){return a.afterRoot&&a.afterRoot(o)})).then(function(){for(const a of o.scenes)a.updateMatrixWorld();s(o)})}).catch(e)}_markDefs(){const s=this.json.nodes||[],e=this.json.skins||[],t=this.json.meshes||[];for(let i=0,r=e.length;i<r;i++){const n=e[i].joints;for(let o=0,a=n.length;o<a;o++)s[n[o]].isBone=!0}for(let i=0,r=s.length;i<r;i++){const n=s[i];n.mesh!==void 0&&(this._addNodeRef(this.meshCache,n.mesh),n.skin!==void 0&&(t[n.mesh].isSkinnedMesh=!0)),n.camera!==void 0&&this._addNodeRef(this.cameraCache,n.camera)}}_addNodeRef(s,e){e!==void 0&&(s.refs[e]===void 0&&(s.refs[e]=s.uses[e]=0),s.refs[e]++)}_getNodeRef(s,e,t){if(s.refs[e]<=1)return t;const i=t.clone(),r=(n,o)=>{const a=this.associations.get(n);a!=null&&this.associations.set(o,a);for(const[c,d]of n.children.entries())r(d,o.children[c])};return r(t,i),i.name+="_instance_"+s.uses[e]++,i}_invokeOne(s){const e=Object.values(this.plugins);e.push(this);for(let t=0;t<e.length;t++){const i=s(e[t]);if(i)return i}return null}_invokeAll(s){const e=Object.values(this.plugins);e.unshift(this);const t=[];for(let i=0;i<e.length;i++){const r=s(e[i]);r&&t.push(r)}return t}getDependency(s,e){const t=s+":"+e;let i=this.cache.get(t);if(!i){switch(s){case"scene":i=this.loadScene(e);break;case"node":i=this._invokeOne(function(r){return r.loadNode&&r.loadNode(e)});break;case"mesh":i=this._invokeOne(function(r){return r.loadMesh&&r.loadMesh(e)});break;case"accessor":i=this.loadAccessor(e);break;case"bufferView":i=this._invokeOne(function(r){return r.loadBufferView&&r.loadBufferView(e)});break;case"buffer":i=this.loadBuffer(e);break;case"material":i=this._invokeOne(function(r){return r.loadMaterial&&r.loadMaterial(e)});break;case"texture":i=this._invokeOne(function(r){return r.loadTexture&&r.loadTexture(e)});break;case"skin":i=this.loadSkin(e);break;case"animation":i=this._invokeOne(function(r){return r.loadAnimation&&r.loadAnimation(e)});break;case"camera":i=this.loadCamera(e);break;default:if(i=this._invokeOne(function(r){return r!=this&&r.getDependency&&r.getDependency(s,e)}),!i)throw new Error("Unknown type: "+s);break}this.cache.add(t,i)}return i}getDependencies(s){let e=this.cache.get(s);if(!e){const t=this,i=this.json[s+(s==="mesh"?"es":"s")]||[];e=Promise.all(i.map(function(r,n){return t.getDependency(s,n)})),this.cache.add(s,e)}return e}loadBuffer(s){const e=this.json.buffers[s],t=this.fileLoader;if(e.type&&e.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+e.type+" buffer type is not supported.");if(e.uri===void 0&&s===0)return Promise.resolve(this.extensions[x.KHR_BINARY_GLTF].body);const i=this.options;return new Promise(function(r,n){t.load(f.LoaderUtils.resolveURL(e.uri,i.path),r,void 0,function(){n(new Error('THREE.GLTFLoader: Failed to load buffer "'+e.uri+'".'))})})}loadBufferView(s){const e=this.json.bufferViews[s];return this.getDependency("buffer",e.buffer).then(function(t){const i=e.byteLength||0,r=e.byteOffset||0;return t.slice(r,r+i)})}loadAccessor(s){const e=this,t=this.json,i=this.json.accessors[s];if(i.bufferView===void 0&&i.sparse===void 0){const n=ee[i.type],o=N[i.componentType],a=i.normalized===!0,c=new o(i.count*n);return Promise.resolve(new f.BufferAttribute(c,n,a))}const r=[];return i.bufferView!==void 0?r.push(this.getDependency("bufferView",i.bufferView)):r.push(null),i.sparse!==void 0&&(r.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(r).then(function(n){const o=n[0],a=ee[i.type],c=N[i.componentType],d=c.BYTES_PER_ELEMENT,u=d*a,g=i.byteOffset||0,m=i.bufferView!==void 0?t.bufferViews[i.bufferView].byteStride:void 0,y=i.normalized===!0;let v,S;if(m&&m!==u){const w=Math.floor(g/m),M="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+w+":"+i.count;let P=e.cache.get(M);P||(v=new c(o,w*m,i.count*m/d),P=new f.InterleavedBuffer(v,m/d),e.cache.add(M,P)),S=new f.InterleavedBufferAttribute(P,a,g%m/d,y)}else o===null?v=new c(i.count*a):v=new c(o,g,i.count*a),S=new f.BufferAttribute(v,a,y);if(i.sparse!==void 0){const w=ee.SCALAR,M=N[i.sparse.indices.componentType],P=i.sparse.indices.byteOffset||0,C=i.sparse.values.byteOffset||0,I=new M(n[1],P,i.sparse.count*w),B=new c(n[2],C,i.sparse.count*a);o!==null&&(S=new f.BufferAttribute(S.array.slice(),S.itemSize,S.normalized)),S.normalized=!1;for(let O=0,H=I.length;O<H;O++){const F=I[O];if(S.setX(F,B[O*a]),a>=2&&S.setY(F,B[O*a+1]),a>=3&&S.setZ(F,B[O*a+2]),a>=4&&S.setW(F,B[O*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}S.normalized=y}return S})}loadTexture(s){const e=this.json,t=this.options,r=e.textures[s].source,n=e.images[r];let o=this.textureLoader;if(n.uri){const a=t.manager.getHandler(n.uri);a!==null&&(o=a)}return this.loadTextureImage(s,r,o)}loadTextureImage(s,e,t){const i=this,r=this.json,n=r.textures[s],o=r.images[e],a=(o.uri||o.bufferView)+":"+n.sampler;if(this.textureCache[a])return this.textureCache[a];const c=this.loadImageSource(e,t).then(function(d){d.flipY=!1,d.name=n.name||o.name||"",d.name===""&&typeof o.uri=="string"&&o.uri.startsWith("data:image/")===!1&&(d.name=o.uri);const g=(r.samplers||{})[n.sampler]||{};return d.magFilter=Ae[g.magFilter]||f.LinearFilter,d.minFilter=Ae[g.minFilter]||f.LinearMipmapLinearFilter,d.wrapS=Te[g.wrapS]||f.RepeatWrapping,d.wrapT=Te[g.wrapT]||f.RepeatWrapping,d.generateMipmaps=!d.isCompressedTexture&&d.minFilter!==f.NearestFilter&&d.minFilter!==f.LinearFilter,i.associations.set(d,{textures:s}),d}).catch(function(){return null});return this.textureCache[a]=c,c}loadImageSource(s,e){const t=this,i=this.json,r=this.options;if(this.sourceCache[s]!==void 0)return this.sourceCache[s].then(u=>u.clone());const n=i.images[s],o=self.URL||self.webkitURL;let a=n.uri||"",c=!1;if(n.bufferView!==void 0)a=t.getDependency("bufferView",n.bufferView).then(function(u){c=!0;const g=new Blob([u],{type:n.mimeType});return a=o.createObjectURL(g),a});else if(n.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+s+" is missing URI and bufferView");const d=Promise.resolve(a).then(function(u){return new Promise(function(g,m){let y=g;e.isImageBitmapLoader===!0&&(y=function(v){const S=new f.Texture(v);S.needsUpdate=!0,g(S)}),e.load(f.LoaderUtils.resolveURL(u,r.path),y,void 0,m)})}).then(function(u){return c===!0&&o.revokeObjectURL(a),_(u,n),u.userData.mimeType=n.mimeType||jt(n.uri),u}).catch(function(u){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),u});return this.sourceCache[s]=d,d}assignTexture(s,e,t,i){const r=this;return this.getDependency("texture",t.index).then(function(n){if(!n)return null;if(t.texCoord!==void 0&&t.texCoord>0&&(n=n.clone(),n.channel=t.texCoord),r.extensions[x.KHR_TEXTURE_TRANSFORM]){const o=t.extensions!==void 0?t.extensions[x.KHR_TEXTURE_TRANSFORM]:void 0;if(o){const a=r.associations.get(n);n=r.extensions[x.KHR_TEXTURE_TRANSFORM].extendTexture(n,o),r.associations.set(n,a)}}return i!==void 0&&(n.colorSpace=i),s[e]=n,n})}assignFinalMaterial(s){const e=s.geometry;let t=s.material;const i=e.attributes.tangent===void 0,r=e.attributes.color!==void 0,n=e.attributes.normal===void 0;if(s.isPoints){const o="PointsMaterial:"+t.uuid;let a=this.cache.get(o);a||(a=new f.PointsMaterial,f.Material.prototype.copy.call(a,t),a.color.copy(t.color),a.map=t.map,a.sizeAttenuation=!1,this.cache.add(o,a)),t=a}else if(s.isLine){const o="LineBasicMaterial:"+t.uuid;let a=this.cache.get(o);a||(a=new f.LineBasicMaterial,f.Material.prototype.copy.call(a,t),a.color.copy(t.color),a.map=t.map,this.cache.add(o,a)),t=a}if(i||r||n){let o="ClonedMaterial:"+t.uuid+":";i&&(o+="derivative-tangents:"),r&&(o+="vertex-colors:"),n&&(o+="flat-shading:");let a=this.cache.get(o);a||(a=t.clone(),r&&(a.vertexColors=!0),n&&(a.flatShading=!0),i&&(a.normalScale&&(a.normalScale.y*=-1),a.clearcoatNormalScale&&(a.clearcoatNormalScale.y*=-1)),this.cache.add(o,a),this.associations.set(a,this.associations.get(t))),t=a}s.material=t}getMaterialType(){return f.MeshStandardMaterial}loadMaterial(s){const e=this,t=this.json,i=this.extensions,r=t.materials[s];let n;const o={},a=r.extensions||{},c=[];if(a[x.KHR_MATERIALS_UNLIT]){const u=i[x.KHR_MATERIALS_UNLIT];n=u.getMaterialType(),c.push(u.extendParams(o,r,e))}else{const u=r.pbrMetallicRoughness||{};if(o.color=new f.Color(1,1,1),o.opacity=1,Array.isArray(u.baseColorFactor)){const g=u.baseColorFactor;o.color.setRGB(g[0],g[1],g[2],f.LinearSRGBColorSpace),o.opacity=g[3]}u.baseColorTexture!==void 0&&c.push(e.assignTexture(o,"map",u.baseColorTexture,f.SRGBColorSpace)),o.metalness=u.metallicFactor!==void 0?u.metallicFactor:1,o.roughness=u.roughnessFactor!==void 0?u.roughnessFactor:1,u.metallicRoughnessTexture!==void 0&&(c.push(e.assignTexture(o,"metalnessMap",u.metallicRoughnessTexture)),c.push(e.assignTexture(o,"roughnessMap",u.metallicRoughnessTexture))),n=this._invokeOne(function(g){return g.getMaterialType&&g.getMaterialType(s)}),c.push(Promise.all(this._invokeAll(function(g){return g.extendMaterialParams&&g.extendMaterialParams(s,o)})))}r.doubleSided===!0&&(o.side=f.DoubleSide);const d=r.alphaMode||se.OPAQUE;if(d===se.BLEND?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,d===se.MASK&&(o.alphaTest=r.alphaCutoff!==void 0?r.alphaCutoff:.5)),r.normalTexture!==void 0&&n!==f.MeshBasicMaterial&&(c.push(e.assignTexture(o,"normalMap",r.normalTexture)),o.normalScale=new f.Vector2(1,1),r.normalTexture.scale!==void 0)){const u=r.normalTexture.scale;o.normalScale.set(u,u)}if(r.occlusionTexture!==void 0&&n!==f.MeshBasicMaterial&&(c.push(e.assignTexture(o,"aoMap",r.occlusionTexture)),r.occlusionTexture.strength!==void 0&&(o.aoMapIntensity=r.occlusionTexture.strength)),r.emissiveFactor!==void 0&&n!==f.MeshBasicMaterial){const u=r.emissiveFactor;o.emissive=new f.Color().setRGB(u[0],u[1],u[2],f.LinearSRGBColorSpace)}return r.emissiveTexture!==void 0&&n!==f.MeshBasicMaterial&&c.push(e.assignTexture(o,"emissiveMap",r.emissiveTexture,f.SRGBColorSpace)),Promise.all(c).then(function(){const u=new n(o);return r.name&&(u.name=r.name),_(u,r),e.associations.set(u,{materials:s}),r.extensions&&U(i,u,r),u})}createUniqueName(s){const e=f.PropertyBinding.sanitizeNodeName(s||"");return e in this.nodeNamesUsed?e+"_"+ ++this.nodeNamesUsed[e]:(this.nodeNamesUsed[e]=0,e)}loadGeometries(s){const e=this,t=this.extensions,i=this.primitiveCache;function r(o){return t[x.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(o,e).then(function(a){return Oe(a,o,e)})}const n=[];for(let o=0,a=s.length;o<a;o++){const c=s[o],d=Et(c),u=i[d];if(u)n.push(u.promise);else{let g;c.extensions&&c.extensions[x.KHR_DRACO_MESH_COMPRESSION]?g=r(c):g=Oe(new f.BufferGeometry,c,e),i[d]={primitive:c,promise:g},n.push(g)}}return Promise.all(n)}loadMesh(s){const e=this,t=this.json,i=this.extensions,r=t.meshes[s],n=r.primitives,o=[];for(let a=0,c=n.length;a<c;a++){const d=n[a].material===void 0?It(this.cache):this.getDependency("material",n[a].material);o.push(d)}return o.push(e.loadGeometries(n)),Promise.all(o).then(function(a){const c=a.slice(0,a.length-1),d=a[a.length-1],u=[];for(let m=0,y=d.length;m<y;m++){const v=d[m],S=n[m];let w;const M=c[m];if(S.mode===T.TRIANGLES||S.mode===T.TRIANGLE_STRIP||S.mode===T.TRIANGLE_FAN||S.mode===void 0)w=r.isSkinnedMesh===!0?new f.SkinnedMesh(v,M):new f.Mesh(v,M),w.isSkinnedMesh===!0&&w.normalizeSkinWeights(),S.mode===T.TRIANGLE_STRIP?w.geometry=xe(w.geometry,f.TriangleStripDrawMode):S.mode===T.TRIANGLE_FAN&&(w.geometry=xe(w.geometry,f.TriangleFanDrawMode));else if(S.mode===T.LINES)w=new f.LineSegments(v,M);else if(S.mode===T.LINE_STRIP)w=new f.Line(v,M);else if(S.mode===T.LINE_LOOP)w=new f.LineLoop(v,M);else if(S.mode===T.POINTS)w=new f.Points(v,M);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+S.mode);Object.keys(w.geometry.morphAttributes).length>0&&Dt(w,r),w.name=e.createUniqueName(r.name||"mesh_"+s),_(w,r),S.extensions&&U(i,w,S),e.assignFinalMaterial(w),u.push(w)}for(let m=0,y=u.length;m<y;m++)e.associations.set(u[m],{meshes:s,primitives:m});if(u.length===1)return r.extensions&&U(i,u[0],r),u[0];const g=new f.Group;r.extensions&&U(i,g,r),e.associations.set(g,{meshes:s});for(let m=0,y=u.length;m<y;m++)g.add(u[m]);return g})}loadCamera(s){let e;const t=this.json.cameras[s],i=t[t.type];if(!i){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return t.type==="perspective"?e=new f.PerspectiveCamera(f.MathUtils.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):t.type==="orthographic"&&(e=new f.OrthographicCamera(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),t.name&&(e.name=this.createUniqueName(t.name)),_(e,t),Promise.resolve(e)}loadSkin(s){const e=this.json.skins[s],t=[];for(let i=0,r=e.joints.length;i<r;i++)t.push(this._loadNodeShallow(e.joints[i]));return e.inverseBindMatrices!==void 0?t.push(this.getDependency("accessor",e.inverseBindMatrices)):t.push(null),Promise.all(t).then(function(i){const r=i.pop(),n=i,o=[],a=[];for(let c=0,d=n.length;c<d;c++){const u=n[c];if(u){o.push(u);const g=new f.Matrix4;r!==null&&g.fromArray(r.array,c*16),a.push(g)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',e.joints[c])}return new f.Skeleton(o,a)})}loadAnimation(s){const e=this.json,t=this,i=e.animations[s],r=i.name?i.name:"animation_"+s,n=[],o=[],a=[],c=[],d=[];for(let u=0,g=i.channels.length;u<g;u++){const m=i.channels[u],y=i.samplers[m.sampler],v=m.target,S=v.node,w=i.parameters!==void 0?i.parameters[y.input]:y.input,M=i.parameters!==void 0?i.parameters[y.output]:y.output;v.node!==void 0&&(n.push(this.getDependency("node",S)),o.push(this.getDependency("accessor",w)),a.push(this.getDependency("accessor",M)),c.push(y),d.push(v))}return Promise.all([Promise.all(n),Promise.all(o),Promise.all(a),Promise.all(c),Promise.all(d)]).then(function(u){const g=u[0],m=u[1],y=u[2],v=u[3],S=u[4],w=[];for(let M=0,P=g.length;M<P;M++){const C=g[M],I=m[M],B=y[M],O=v[M],H=S[M];if(C===void 0)continue;C.updateMatrix&&C.updateMatrix();const F=t._createAnimationTracks(C,I,B,O,H);if(F)for(let oe=0;oe<F.length;oe++)w.push(F[oe])}return new f.AnimationClip(r,void 0,w)})}createNodeMesh(s){const e=this.json,t=this,i=e.nodes[s];return i.mesh===void 0?null:t.getDependency("mesh",i.mesh).then(function(r){const n=t._getNodeRef(t.meshCache,i.mesh,r);return i.weights!==void 0&&n.traverse(function(o){if(o.isMesh)for(let a=0,c=i.weights.length;a<c;a++)o.morphTargetInfluences[a]=i.weights[a]}),n})}loadNode(s){const e=this.json,t=this,i=e.nodes[s],r=t._loadNodeShallow(s),n=[],o=i.children||[];for(let c=0,d=o.length;c<d;c++)n.push(t.getDependency("node",o[c]));const a=i.skin===void 0?Promise.resolve(null):t.getDependency("skin",i.skin);return Promise.all([r,Promise.all(n),a]).then(function(c){const d=c[0],u=c[1],g=c[2];g!==null&&d.traverse(function(m){m.isSkinnedMesh&&m.bind(g,kt)});for(let m=0,y=u.length;m<y;m++)d.add(u[m]);return d})}_loadNodeShallow(s){const e=this.json,t=this.extensions,i=this;if(this.nodeCache[s]!==void 0)return this.nodeCache[s];const r=e.nodes[s],n=r.name?i.createUniqueName(r.name):"",o=[],a=i._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(s)});return a&&o.push(a),r.camera!==void 0&&o.push(i.getDependency("camera",r.camera).then(function(c){return i._getNodeRef(i.cameraCache,r.camera,c)})),i._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(s)}).forEach(function(c){o.push(c)}),this.nodeCache[s]=Promise.all(o).then(function(c){let d;if(r.isBone===!0?d=new f.Bone:c.length>1?d=new f.Group:c.length===1?d=c[0]:d=new f.Object3D,d!==c[0])for(let u=0,g=c.length;u<g;u++)d.add(c[u]);if(r.name&&(d.userData.name=r.name,d.name=n),_(d,r),r.extensions&&U(t,d,r),r.matrix!==void 0){const u=new f.Matrix4;u.fromArray(r.matrix),d.applyMatrix4(u)}else r.translation!==void 0&&d.position.fromArray(r.translation),r.rotation!==void 0&&d.quaternion.fromArray(r.rotation),r.scale!==void 0&&d.scale.fromArray(r.scale);if(!i.associations.has(d))i.associations.set(d,{});else if(r.mesh!==void 0&&i.meshCache.refs[r.mesh]>1){const u=i.associations.get(d);i.associations.set(d,{...u})}return i.associations.get(d).nodes=s,d}),this.nodeCache[s]}loadScene(s){const e=this.extensions,t=this.json.scenes[s],i=this,r=new f.Group;t.name&&(r.name=i.createUniqueName(t.name)),_(r,t),t.extensions&&U(e,r,t);const n=t.nodes||[],o=[];for(let a=0,c=n.length;a<c;a++)o.push(i.getDependency("node",n[a]));return Promise.all(o).then(function(a){for(let d=0,u=a.length;d<u;d++)r.add(a[d]);const c=d=>{const u=new Map;for(const[g,m]of i.associations)(g instanceof f.Material||g instanceof f.Texture)&&u.set(g,m);return d.traverse(g=>{const m=i.associations.get(g);m!=null&&u.set(g,m)}),u};return i.associations=c(r),r})}_createAnimationTracks(s,e,t,i,r){const n=[],o=s.name?s.name:s.uuid,a=[];k[r.path]===k.weights?s.traverse(function(g){g.morphTargetInfluences&&a.push(g.name?g.name:g.uuid)}):a.push(o);let c;switch(k[r.path]){case k.weights:c=f.NumberKeyframeTrack;break;case k.rotation:c=f.QuaternionKeyframeTrack;break;case k.translation:case k.scale:c=f.VectorKeyframeTrack;break;default:switch(t.itemSize){case 1:c=f.NumberKeyframeTrack;break;case 2:case 3:default:c=f.VectorKeyframeTrack;break}break}const d=i.interpolation!==void 0?Rt[i.interpolation]:f.InterpolateLinear,u=this._getArrayFromAccessor(t);for(let g=0,m=a.length;g<m;g++){const y=new c(a[g]+"."+k[r.path],e.array,u,d);i.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(y),n.push(y)}return n}_getArrayFromAccessor(s){let e=s.array;if(s.normalized){const t=re(e.constructor),i=new Float32Array(e.length);for(let r=0,n=e.length;r<n;r++)i[r]=e[r]*t;e=i}return e}_createCubicSplineTrackInterpolant(s){s.createInterpolant=function(t){const i=this instanceof f.QuaternionKeyframeTrack?Ot:Pe;return new i(this.times,this.values,this.getValueSize()/3,t)},s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Ft(h,s,e){const t=s.attributes,i=new f.Box3;if(t.POSITION!==void 0){const o=e.json.accessors[t.POSITION],a=o.min,c=o.max;if(a!==void 0&&c!==void 0){if(i.set(new f.Vector3(a[0],a[1],a[2]),new f.Vector3(c[0],c[1],c[2])),o.normalized){const d=re(N[o.componentType]);i.min.multiplyScalar(d),i.max.multiplyScalar(d)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const r=s.targets;if(r!==void 0){const o=new f.Vector3,a=new f.Vector3;for(let c=0,d=r.length;c<d;c++){const u=r[c];if(u.POSITION!==void 0){const g=e.json.accessors[u.POSITION],m=g.min,y=g.max;if(m!==void 0&&y!==void 0){if(a.setX(Math.max(Math.abs(m[0]),Math.abs(y[0]))),a.setY(Math.max(Math.abs(m[1]),Math.abs(y[1]))),a.setZ(Math.max(Math.abs(m[2]),Math.abs(y[2]))),g.normalized){const v=re(N[g.componentType]);a.multiplyScalar(v)}o.max(a)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(o)}h.boundingBox=i;const n=new f.Sphere;i.getCenter(n.center),n.radius=i.min.distanceTo(i.max)/2,h.boundingSphere=n}function Oe(h,s,e){const t=s.attributes,i=[];function r(n,o){return e.getDependency("accessor",n).then(function(a){h.setAttribute(o,a)})}for(const n in t){const o=te[n]||n.toLowerCase();o in h.attributes||i.push(r(t[n],o))}if(s.indices!==void 0&&!h.index){const n=e.getDependency("accessor",s.indices).then(function(o){h.setIndex(o)});i.push(n)}return f.ColorManagement.workingColorSpace!==f.LinearSRGBColorSpace&&"COLOR_0"in t&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${f.ColorManagement.workingColorSpace}" not supported.`),_(h,s),Ft(h,s,e),Promise.all(i).then(function(){return s.targets!==void 0?_t(h,s.targets,e):h})}const ne=new WeakMap;class Ut extends f.Loader{constructor(s){super(s),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(s){return this.decoderPath=s,this}setDecoderConfig(s){return this.decoderConfig=s,this}setWorkerLimit(s){return this.workerLimit=s,this}load(s,e,t,i){const r=new f.FileLoader(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(s,n=>{this.parse(n,e,i)},t,i)}parse(s,e,t=()=>{}){this.decodeDracoFile(s,e,null,null,f.SRGBColorSpace,t).catch(t)}decodeDracoFile(s,e,t,i,r=f.LinearSRGBColorSpace,n=()=>{}){const o={attributeIDs:t||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!t,vertexColorSpace:r};return this.decodeGeometry(s,o).then(e).catch(n)}decodeGeometry(s,e){const t=JSON.stringify(e);if(ne.has(s)){const a=ne.get(s);if(a.key===t)return a.promise;if(s.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let i;const r=this.workerNextTaskID++,n=s.byteLength,o=this._getWorker(r,n).then(a=>(i=a,new Promise((c,d)=>{i._callbacks[r]={resolve:c,reject:d},i.postMessage({type:"decode",id:r,taskConfig:e,buffer:s},[s])}))).then(a=>this._createGeometry(a.geometry));return o.catch(()=>!0).then(()=>{i&&r&&this._releaseTask(i,r)}),ne.set(s,{key:t,promise:o}),o}_createGeometry(s){const e=new f.BufferGeometry;s.index&&e.setIndex(new f.BufferAttribute(s.index.array,1));for(let t=0;t<s.attributes.length;t++){const i=s.attributes[t],r=i.name,n=i.array,o=i.itemSize,a=new f.BufferAttribute(n,o);r==="color"&&(this._assignVertexColorSpace(a,i.vertexColorSpace),a.normalized=!(n instanceof Float32Array)),e.setAttribute(r,a)}return e}_assignVertexColorSpace(s,e){if(e!==f.SRGBColorSpace)return;const t=new f.Color;for(let i=0,r=s.count;i<r;i++)t.fromBufferAttribute(s,i),f.ColorManagement.colorSpaceToWorking(t,f.SRGBColorSpace),s.setXYZ(i,t.r,t.g,t.b)}_loadLibrary(s,e){const t=new f.FileLoader(this.manager);return t.setPath(this.decoderPath),t.setResponseType(e),t.setWithCredentials(this.withCredentials),new Promise((i,r)=>{t.load(s,i,void 0,r)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const s=typeof WebAssembly!="object"||this.decoderConfig.type==="js",e=[];return s?e.push(this._loadLibrary("draco_decoder.js","text")):(e.push(this._loadLibrary("draco_wasm_wrapper.js","text")),e.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(e).then(t=>{const i=t[0];s||(this.decoderConfig.wasmBinary=t[1]);const r=Nt.toString(),n=["/* draco decoder */",i,"","/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([n]))}),this.decoderPending}_getWorker(s,e){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const i=new Worker(this.workerSourceURL);i._callbacks={},i._taskCosts={},i._taskLoad=0,i.postMessage({type:"init",decoderConfig:this.decoderConfig}),i.onmessage=function(r){const n=r.data;switch(n.type){case"decode":i._callbacks[n.id].resolve(n);break;case"error":i._callbacks[n.id].reject(n);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+n.type+'"')}},this.workerPool.push(i)}else this.workerPool.sort(function(i,r){return i._taskLoad>r._taskLoad?-1:1});const t=this.workerPool[this.workerPool.length-1];return t._taskCosts[s]=e,t._taskLoad+=e,t})}_releaseTask(s,e){s._taskLoad-=s._taskCosts[e],delete s._callbacks[e],delete s._taskCosts[e]}debug(){console.log("Task load: ",this.workerPool.map(s=>s._taskLoad))}dispose(){for(let s=0;s<this.workerPool.length;++s)this.workerPool[s].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function Nt(){let h,s;onmessage=function(n){const o=n.data;switch(o.type){case"init":h=o.decoderConfig,s=new Promise(function(d){h.onModuleLoaded=function(u){d({draco:u})},DracoDecoderModule(h)});break;case"decode":const a=o.buffer,c=o.taskConfig;s.then(d=>{const u=d.draco,g=new u.Decoder;try{const m=e(u,g,new Int8Array(a),c),y=m.attributes.map(v=>v.array.buffer);m.index&&y.push(m.index.array.buffer),self.postMessage({type:"decode",id:o.id,geometry:m},y)}catch(m){console.error(m),self.postMessage({type:"error",id:o.id,error:m.message})}finally{u.destroy(g)}});break}};function e(n,o,a,c){const d=c.attributeIDs,u=c.attributeTypes;let g,m;const y=o.GetEncodedGeometryType(a);if(y===n.TRIANGULAR_MESH)g=new n.Mesh,m=o.DecodeArrayToMesh(a,a.byteLength,g);else if(y===n.POINT_CLOUD)g=new n.PointCloud,m=o.DecodeArrayToPointCloud(a,a.byteLength,g);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!m.ok()||g.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+m.error_msg());const v={index:null,attributes:[]};for(const S in d){const w=self[u[S]];let M,P;if(c.useUniqueIDs)P=d[S],M=o.GetAttributeByUniqueId(g,P);else{if(P=o.GetAttributeId(g,n[d[S]]),P===-1)continue;M=o.GetAttribute(g,P)}const C=i(n,o,g,S,w,M);S==="color"&&(C.vertexColorSpace=c.vertexColorSpace),v.attributes.push(C)}return y===n.TRIANGULAR_MESH&&(v.index=t(n,o,g)),n.destroy(g),v}function t(n,o,a){const d=a.num_faces()*3,u=d*4,g=n._malloc(u);o.GetTrianglesUInt32Array(a,u,g);const m=new Uint32Array(n.HEAPF32.buffer,g,d).slice();return n._free(g),{array:m,itemSize:1}}function i(n,o,a,c,d,u){const g=u.num_components(),y=a.num_points()*g,v=y*d.BYTES_PER_ELEMENT,S=r(n,d),w=n._malloc(v);o.GetAttributeDataArrayForAllPoints(a,u,S,v,w);const M=new d(n.HEAPF32.buffer,w,y).slice();return n._free(w),{name:c,array:M,itemSize:g}}function r(n,o){switch(o){case Float32Array:return n.DT_FLOAT32;case Int8Array:return n.DT_INT8;case Int16Array:return n.DT_INT16;case Int32Array:return n.DT_INT32;case Uint8Array:return n.DT_UINT8;case Uint16Array:return n.DT_UINT16;case Uint32Array:return n.DT_UINT32}}}class Gt extends A{constructor(e){super();l(this,"name","GLBLoaderScript");l(this,"config");l(this,"gltfLoader");l(this,"dracoLoader",null);l(this,"loadedModels",new Map);l(this,"loadingModels",new Map);l(this,"mixers",new Map);l(this,"materials",null);l(this,"vector3Pool");l(this,"eulerPool");this.config={enableDraco:!1,dracoDecoderPath:"/draco/",autoOptimize:!0,autoAddToScene:!1,defaultMaterial:{roughness:.5,metalness:0,envMapIntensity:1},scale:new p.Vector3(1,1,1),position:new p.Vector3(0,0,0),rotation:new p.Euler(0,0,0),materials:null,overrideMaterial:null,...e},this.gltfLoader=new rt,this.setupDracoLoader(),this.vector3Pool=new j(()=>new p.Vector3,t=>t.set(0,0,0)),this.eulerPool=new j(()=>new p.Euler,t=>t.set(0,0,0))}awake(){var e;(e=super.awake)==null||e.call(this)}onEnable(){var e;(e=super.onEnable)==null||e.call(this)}async start(){var e;(e=super.start)==null||e.call(this)}update(e){var t;(t=super.update)==null||t.call(this,e);for(const i of this.mixers.values())i.update(e)}onResize(){super.onResize()}onDisable(){var e;(e=super.onDisable)==null||e.call(this)}destroy(){var e;(e=super.destroy)==null||e.call(this),this.mixers.clear(),this.loadedModels.clear(),this.loadingModels.clear(),this.dracoLoader&&(this.dracoLoader.dispose(),this.dracoLoader=null)}setupDracoLoader(){if(this.config.enableDraco)try{this.dracoLoader=new Ut,this.dracoLoader.setDecoderPath(this.config.dracoDecoderPath),this.gltfLoader.setDRACOLoader(this.dracoLoader)}catch(e){console.warn("[GLBLoaderScript] Draco加载器设置失败，已禁用Draco支持:",e),this.config.enableDraco=!1}}optimizeModel(e){this.config.autoOptimize&&e.scene.traverse(t=>{if(t instanceof p.Mesh){if(t.castShadow=!0,t.receiveShadow=!0,this.config.overrideMaterial)t.material=this.config.overrideMaterial;else if(t.material instanceof p.MeshStandardMaterial){const i=t.material,r=this.config.defaultMaterial;r.roughness!==void 0&&(i.roughness=r.roughness),r.metalness!==void 0&&(i.metalness=r.metalness),r.envMapIntensity!==void 0&&(i.envMapIntensity=r.envMapIntensity),i.color.setHex(1381653),i.needsUpdate=!0}t.geometry&&(t.geometry.boundingBox||t.geometry.computeBoundingBox(),t.geometry.boundingSphere||t.geometry.computeBoundingSphere())}})}applyTransforms(e){const t=this.vector3Pool.acquire(),i=this.vector3Pool.acquire(),r=this.eulerPool.acquire();t.copy(this.config.scale),i.copy(this.config.position),r.copy(this.config.rotation),e.scale.copy(t),e.position.copy(i),e.rotation.copy(r),this.vector3Pool.release(t),this.vector3Pool.release(i),this.eulerPool.release(r)}createAnimationMixer(e,t,i){const r=new p.AnimationMixer(e),n={};return t.forEach(o=>{const a=r.clipAction(o);n[o.name]=a}),this.mixers.set(i,r),{mixer:r,actions:n,play:(o,a=!0)=>{const c=n[o];c&&(a&&c.setLoop(p.LoopRepeat,1/0),c.play())},stop:o=>{const a=n[o];a&&a.stop()},fadeIn:(o,a=.5)=>{const c=n[o];c&&c.reset().fadeIn(a).play()},fadeOut:(o,a=.5)=>{const c=n[o];c&&c.fadeOut(a)},crossFade:(o,a,c=1)=>{const d=n[o],u=n[a];d&&u&&(d.fadeOut(c),u.reset().fadeIn(c).play())}}}async loadModel(e,t={}){const i=this.loadedModels.get(e);if(i){const o=this.cloneModel(i);if(t.position){const a=this.vector3Pool.acquire();a.copy(t.position),o.scene.position.copy(a),this.vector3Pool.release(a)}if(t.scale){const a=this.vector3Pool.acquire();a.copy(t.scale),o.scene.scale.copy(a),this.vector3Pool.release(a)}if(t.rotation){const a=this.eulerPool.acquire();a.copy(t.rotation),o.scene.rotation.copy(a),this.eulerPool.release(a)}return(t.addToScene??this.config.autoAddToScene)&&this.addObject(o.scene),o}const r=this.loadingModels.get(e);if(r)return r;const n=new Promise((o,a)=>{this.gltfLoader.load(e,c=>{const d={scene:c.scene,animations:c.animations||[],cameras:c.cameras||[],parser:c.parser,materials:c.materials||[],userData:c.userData||{}};if(this.optimizeModel(d),this.applyTransforms(d.scene),t.position){const u=this.vector3Pool.acquire();u.copy(t.position),d.scene.position.copy(u),this.vector3Pool.release(u)}if(t.scale){const u=this.vector3Pool.acquire();u.copy(t.scale),d.scene.scale.copy(u),this.vector3Pool.release(u)}if(t.rotation){const u=this.eulerPool.acquire();u.copy(t.rotation),d.scene.rotation.copy(u),this.eulerPool.release(u)}if(t.material&&d.scene.traverse(u=>{u instanceof p.Mesh&&(u.material=t.material)}),d.animations.length>0){const u=this.createAnimationMixer(d.scene,d.animations,e);d.mixer=u.mixer,d.actions=u.actions,d.playAnimation=u.play,d.stopAnimation=u.stop,d.fadeInAnimation=u.fadeIn,d.fadeOutAnimation=u.fadeOut,d.crossFadeAnimation=u.crossFade}t.addToScene??this.config.autoAddToScene?this.addObject(d.scene):console.log("[GLBLoaderScript] 模型未添加到场景中"),this.loadedModels.set(e,d),this.loadingModels.delete(e),o(d)},c=>{const d={loaded:c.loaded,total:c.total,percentage:c.total>0?c.loaded/c.total*100:0,url:e};t.onProgress&&t.onProgress(d)},c=>{console.error(`[GLBLoaderScript] 加载GLB模型失败: ${e}`,c),this.loadingModels.delete(e),t.onError&&t.onError(c),a(c)})});return this.loadingModels.set(e,n),n}cloneModel(e){return{scene:e.scene.clone(),animations:[...e.animations],cameras:[...e.cameras],materials:[...e.materials],parser:e.parser,userData:{...e.userData}}}removeModel(e,t=!0){const i=this.loadedModels.get(e);i&&t&&this.removeObject(i.scene);const r=this.mixers.get(e);r&&(r.stopAllAction(),this.mixers.delete(e)),this.loadedModels.delete(e)}getModel(e){return this.loadedModels.get(e)}getAllModels(){return Array.from(this.loadedModels.entries()).map(([e,t])=>({url:e,model:t}))}clearScene(e=!1){for(const[t,i]of this.loadedModels.entries()){this.removeObject(i.scene);const r=this.mixers.get(t);r&&(r.stopAllAction(),e&&this.mixers.delete(t))}e&&(this.loadedModels.clear(),this.loadingModels.clear(),this.mixers.clear())}getSceneModelCount(){return this.loadedModels.size}isModelInScene(e){const t=this.loadedModels.get(e);return t?this.scene.children.includes(t.scene):!1}addModelToScene(e){const t=this.loadedModels.get(e);return t?(this.scene.children.includes(t.scene)||this.addObject(t.scene),!0):(console.warn(`[GLBLoaderScript] 无法添加模型到场景: ${e}`),!1)}removeModelFromScene(e){const t=this.loadedModels.get(e);if(!t)return console.warn(`[GLBLoaderScript] 无法从场景中移除模型: ${e}`),!1;this.removeObject(t.scene);const i=this.mixers.get(e);return i&&i.stopAllAction(),!0}updateConfig(e){Object.assign(this.config,e),(e.enableDraco!==void 0||e.dracoDecoderPath)&&this.setupDracoLoader()}getConfig(){return{...this.config}}}class zt extends A{constructor(e){super();l(this,"animations",new Map);l(this,"defaultConfig",{targetName:"",scrollSpeedX:0,scrollSpeedY:0,scaleSpeedX:0,scaleSpeedY:0,rotationSpeed:0,enabled:!0,transparent:!1,opacity:1,doubleSided:!1});l(this,"sceneCreationConfig",null);l(this,"sharedTexture",null);l(this,"alphaMap",null);this.name="UVAnimationScript",e&&(Array.isArray(e)?e.forEach(t=>this.addAnimation(t)):this.addAnimation(e))}setSceneCreationConfig(e){this.sceneCreationConfig=e}loadTexture(e){return new Promise((t,i)=>{new p.TextureLoader().load(e,n=>{n.wrapS=p.RepeatWrapping,n.wrapT=p.RepeatWrapping,n.format=p.RGBAFormat,t(n)},void 0,n=>{console.error("[UVAnimationScript] 纹理加载失败:",n),i(n)})})}createGradientAlphaMap(e="bottomToTop"){const t=document.createElement("canvas");t.width=256,t.height=256;const i=t.getContext("2d");let r;switch(e){case"bottomToTop":r=i.createLinearGradient(0,t.height,0,0);break;case"topToBottom":r=i.createLinearGradient(0,0,0,t.height);break;case"leftToRight":r=i.createLinearGradient(0,0,t.width,0);break;case"rightToLeft":r=i.createLinearGradient(t.width,0,0,0);break;default:r=i.createLinearGradient(0,t.height,0,0)}r.addColorStop(0,"rgba(0, 0, 0, 0)"),r.addColorStop(1,"rgba(255, 255, 255, 1)"),i.fillStyle=r,i.fillRect(0,0,t.width,t.height);const n=new p.CanvasTexture(t);return n.wrapS=p.RepeatWrapping,n.wrapT=p.RepeatWrapping,n}loadAlphaMap(e){return new Promise(t=>{new p.TextureLoader().load(e,r=>{r.wrapS=p.RepeatWrapping,r.wrapT=p.RepeatWrapping,r.format=p.RedFormat,t(r)},void 0,r=>{console.error("[UVAnimationScript] Alpha贴图加载失败:",r),t(null)})})}async createSceneObjects(){var e,t,i,r,n,o,a,c,d,u;if(!(!this.sceneCreationConfig||!this.renderer))try{if(this.sharedTexture=await this.loadTexture(this.sceneCreationConfig.textureUrl),this.sceneCreationConfig.alphaMapUrl)try{this.alphaMap=await this.loadAlphaMap(this.sceneCreationConfig.alphaMapUrl),this.alphaMap?console.log("[UVAnimationScript] 成功加载外部alpha贴图"):this.sceneCreationConfig.enableGradientAlpha&&(console.warn("[UVAnimationScript] 外部alpha贴图加载失败，使用程序生成的渐变贴图"),this.alphaMap=this.createGradientAlphaMap(this.sceneCreationConfig.gradientDirection))}catch(m){this.sceneCreationConfig.enableGradientAlpha&&(console.warn("[UVAnimationScript] 外部alpha贴图加载失败，使用程序生成的渐变贴图:",m),this.alphaMap=this.createGradientAlphaMap(this.sceneCreationConfig.gradientDirection))}else this.sceneCreationConfig.enableGradientAlpha&&(this.alphaMap=this.createGradientAlphaMap(this.sceneCreationConfig.gradientDirection));const g=new p.MeshStandardMaterial({color:"#ffffff",transparent:!0,map:this.sharedTexture,alphaMap:this.alphaMap||void 0,opacity:1,depthWrite:!0,blending:p.AdditiveBlending});for(const m of this.sceneCreationConfig.objects){let y,v;switch(m.type){case"plane":y=new p.PlaneGeometry(((e=m.size)==null?void 0:e[0])||2,((t=m.size)==null?void 0:t[1])||2,((i=m.size)==null?void 0:i[2])||1),v=new p.Mesh(y,g),m.rotation&&v.rotation.set(...m.rotation);break;case"cylinder":y=new p.CylinderGeometry(((r=m.size)==null?void 0:r[0])||.5,((n=m.size)==null?void 0:n[1])||.5,((o=m.size)==null?void 0:o[2])||1,((a=m.size)==null?void 0:a[3])||32),v=new p.Mesh(y,g);break;case"box":y=new p.BoxGeometry(((c=m.size)==null?void 0:c[0])||1,((d=m.size)==null?void 0:d[1])||1,((u=m.size)==null?void 0:u[2])||1),v=new p.Mesh(y,g);break;default:console.warn(`[UVAnimationScript] Unsupported object type: ${m.type}`);continue}if(m.position&&v.position.set(...m.position),v.name=m.name,this.addObject(v),this.animations.has(m.name)){const S=this.animations.get(m.name);S.mesh=v,this.applyMaterialConfig(S)}console.log(`[UVAnimationScript] Created object: ${m.name}`)}if(this.sceneCreationConfig.lights)for(const m of this.sceneCreationConfig.lights){let y;switch(m.type){case"ambient":y=new p.AmbientLight(m.color||4210752,m.intensity||.5);break;case"directional":y=new p.DirectionalLight(m.color||16777215,m.intensity||1),m.direction?y.position.set(...m.direction):y.position.set(5,10,7),y.castShadow=!0;break;case"point":y=new p.PointLight(m.color||16777215,m.intensity||1,100,1),m.position?y.position.set(...m.position):y.position.set(0,5,0),y.castShadow=!0;break;case"spot":if(y=new p.SpotLight(m.color||16777215,m.intensity||1,100,Math.PI/4,.5,1),m.position?y.position.set(...m.position):y.position.set(0,10,0),m.direction){const v=new p.Object3D;v.position.set(...m.direction),this.addObject(v),y.target=v}y.castShadow=!0;break;default:console.warn(`[UVAnimationScript] Unsupported light type: ${m.type}`);continue}y.name=`${m.type}Light`,this.addObject(y),console.log(`[UVAnimationScript] Created light: ${m.type}`)}this.scene.name==="main"&&this.addTitleElement()}catch(g){console.error("[UVAnimationScript] Failed to create scene objects:",g)}}addTitleElement(){const e=document.createElement("div");e.innerHTML=`
            <h1 style="color: white; text-align: center; margin-top: 20px;">UV动画测试 - 镂空贴图效果</h1>
            <p style="color: #ccc; text-align: center;">黑色部分形成镂空效果，可以透过看到背景</p>
            <p style="color: #ccc; text-align: center;">常用于制作树叶、栅栏、装饰图案等</p>
            <p style="color: #ccc; text-align: center;">使用鼠标拖拽旋转视角，滚动缩放</p>
        `,e.style.position="absolute",e.style.top="0",e.style.width="100%",e.style.zIndex="100",e.style.pointerEvents="none",document.body.appendChild(e)}addAnimation(e){const t={...this.defaultConfig,...e};if(this.animations.has(t.targetName)){console.warn(`[UVAnimationScript] Animation for target "${t.targetName}" already exists`);return}this.animations.set(t.targetName,{mesh:null,config:t,offset:new p.Vector2(0,0),scale:new p.Vector2(1,1),rotation:0})}removeAnimation(e){const t=this.animations.get(e);t&&(t.mesh&&t.mesh.material&&this.resetMaterialUV(t.mesh.material),this.animations.delete(e))}updateAnimation(e,t){const i=this.animations.get(e);i&&Object.assign(i.config,t)}enableAnimation(e){const t=this.animations.get(e);t&&(t.config.enabled=!0)}disableAnimation(e){const t=this.animations.get(e);t&&(t.config.enabled=!1)}getAnimationConfig(e){const t=this.animations.get(e);return t?t.config:void 0}resetMaterialUV(e){Array.isArray(e)?e.forEach(t=>this.resetSingleMaterialUV(t)):this.resetSingleMaterialUV(e)}resetSingleMaterialUV(e){if(e.map){const t=e.map;t.offset.set(0,0),t.repeat.set(1,1)}}start(){var e;(e=super.start)==null||e.call(this),this.createSceneObjects().then(()=>{this.animations.forEach((t,i)=>{if(!t.mesh){const r=this.scene.getObjectByName(i);r&&r instanceof p.Mesh?(t.mesh=r,this.applyMaterialConfig(t),console.log(`[UVAnimationScript] Found target mesh: ${i}`)):console.warn(`[UVAnimationScript] Target mesh not found: ${i}`)}})})}applyMaterialConfig(e){const t=e.mesh.material,i=r=>{e.config.transparent!==void 0&&(r.transparent=e.config.transparent),e.config.opacity!==void 0&&(r.opacity=e.config.opacity),e.config.doubleSided!==void 0&&(r.side=e.config.doubleSided?p.DoubleSide:p.FrontSide)};Array.isArray(t)?t.forEach(i):i(t)}update(e){var t;(t=super.update)==null||t.call(this,e),this.animations.forEach(i=>{!i.config.enabled||!i.mesh||(i.offset.x+=i.config.scrollSpeedX*e,i.offset.y+=i.config.scrollSpeedY*e,i.scale.x+=i.config.scaleSpeedX*e,i.scale.y+=i.config.scaleSpeedY*e,i.rotation+=i.config.rotationSpeed*e,this.applyUVTransform(i))})}applyUVTransform(e){const t=e.mesh.material;if(!t)return;const i=r=>{if(r.map){const n=r.map;n.wrapS=p.RepeatWrapping,n.wrapT=p.RepeatWrapping,n.offset.x=e.offset.x,n.offset.y=e.offset.y,n.repeat.x=e.scale.x,n.repeat.y=e.scale.y,n.needsUpdate=!0}};Array.isArray(t)?t.forEach(i):i(t)}destroy(){var t;(t=super.destroy)==null||t.call(this),document.querySelectorAll("div h1, div p").forEach(i=>{var r,n;(r=i.textContent)!=null&&r.includes("UV动画测试")&&((n=i.parentElement)==null||n.remove())}),this.animations.forEach(i=>{i.mesh&&i.mesh.material&&this.resetMaterialUV(i.mesh.material)}),this.sharedTexture&&this.sharedTexture.dispose(),this.alphaMap&&this.alphaMap.dispose(),this.animations.clear()}}class Ht extends p.MeshStandardMaterial{constructor(e){const t=(e==null?void 0:e.transparent)??!1,i=!!(e!=null&&e.alphaMap),r=(e==null?void 0:e.opacity)??1,n=(e==null?void 0:e.depthWrite)??!(t||i||r<1);super({color:e==null?void 0:e.color,transparent:t,opacity:r,map:e==null?void 0:e.texture,alphaTest:.05,alphaMap:e==null?void 0:e.alphaMap,side:e!=null&&e.doubleSided?p.DoubleSide:p.FrontSide,blending:p.AdditiveBlending,depthWrite:n});l(this,"_uvOffset",new p.Vector2(0,0));l(this,"_uvScale",new p.Vector2(1,1));l(this,"_uvRotation",0);(t||i||r<1)&&(this.depthWrite=!1,this.transparent=!0),e!=null&&e.uvOffset&&this._uvOffset.copy(e.uvOffset),e!=null&&e.uvScale&&this._uvScale.copy(e.uvScale),this.map&&(this.map.wrapS=p.RepeatWrapping,this.map.wrapT=p.RepeatWrapping),this.alphaMap&&(this.alphaMap.wrapS=p.RepeatWrapping,this.alphaMap.wrapT=p.RepeatWrapping)}get uvOffset(){return this._uvOffset.clone()}set uvOffset(e){this._uvOffset.copy(e),this.updateUVTransform()}get uvScale(){return this._uvScale.clone()}set uvScale(e){this._uvScale.copy(e),this.updateUVTransform()}get uvRotation(){return this._uvRotation}set uvRotation(e){this._uvRotation=e,this.updateUVTransform()}updateUVTransform(){this.map&&(this.map.offset.copy(this._uvOffset),this.map.repeat.copy(this._uvScale),this.map.needsUpdate=!0)}scrollUV(e,t){this._uvOffset.x+=e,this._uvOffset.y+=t,this.updateUVTransform()}scaleUV(e,t){this._uvScale.x+=e,this._uvScale.y+=t,this.updateUVTransform()}resetUV(){this._uvOffset.set(0,0),this._uvScale.set(1,1),this._uvRotation=0,this.updateUVTransform()}setUVTransform(e,t,i){e&&this._uvOffset.copy(e),t&&this._uvScale.copy(t),i!==void 0&&(this._uvRotation=i),this.updateUVTransform()}getUVTransform(){return{offset:this._uvOffset.clone(),scale:this._uvScale.clone(),rotation:this._uvRotation}}}class Vt extends p.ShaderMaterial{constructor(s={}){const e=s.glowColor!==void 0?s.glowColor instanceof p.Color?s.glowColor:new p.Color(s.glowColor):"#fffb2e",t=s.baseBrightness!==void 0?s.baseBrightness:.8,i=s.side!==void 0?s.side:p.FrontSide;super({uniforms:{map:{value:s.map||null},aoMap:{value:s.aoMap||null},glowColor:{value:e},glowIntensity:{value:s.glowIntensity!==void 0?s.glowIntensity:2},baseBrightness:{value:t}},side:i,vertexShader:`
                varying vec2 vUv;
                varying vec3 vNormal;
                varying vec2 vUv2; // 第二UV坐标用于AO贴图
                void main() {
                    vUv = uv;
                    vNormal = normalize(normalMatrix * normal);
                    // 如果存在第二UV坐标则使用，否则使用第一UV坐标
                    #ifdef USE_UV2
                        vUv2 = uv2;
                    #else
                        vUv2 = uv;
                    #endif
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                uniform sampler2D map;
                uniform sampler2D glowMap;
                uniform vec3 glowColor;
                uniform float glowIntensity;
                uniform float baseBrightness;
                varying vec2 vUv;
                varying vec3 vNormal;
                varying vec2 vUv2;

                void main() {
                    vec4 texColor = texture2D(map, vUv);
                    // 从AO贴图获取环境光遮蔽值
                    vec4 aoValue = texture2D(glowMap, vUv2);
                    
                    // 直接使用AO贴图的灰度值控制自发光（反向效果）
                    // AO贴图中较暗的区域（灰度值接近0）会产生更强的自发光
                    // 1.0 - aoValue.r 实现反向效果：暗部发光，亮部不发光
                    float glowFactor = (1.0 - aoValue.r) * glowIntensity;
                    
                    // 调整基础颜色亮度，避免过白
                    vec3 adjustedBaseColor = texColor.rgb * baseBrightness;
                    
                    // 计算最终颜色：调整后的基础纹理颜色 + 自发光颜色
                    vec3 finalColor = adjustedBaseColor + glowColor * glowFactor;
                    
                    // 限制最大亮度，避免过曝
                    finalColor = min(finalColor, vec3(1.0));
                    
                    gl_FragColor = vec4(finalColor, texColor.a);
                }
            `})}get map(){return this.uniforms.map.value}set map(s){this.uniforms.map.value=s}get glowMap(){return this.uniforms.glowMap.value}set glowMap(s){this.uniforms.glowMap.value=s}get glowColor(){return this.uniforms.glowColor.value}set glowColor(s){this.uniforms.glowColor.value=s}get glowIntensity(){return this.uniforms.glowIntensity.value}set glowIntensity(s){this.uniforms.glowIntensity.value=s}get baseBrightness(){return this.uniforms.baseBrightness.value}set baseBrightness(s){this.uniforms.baseBrightness.value=s}setSide(s){this.side=s}}class Wt extends p.ShaderMaterial{constructor(e){const t={side:p.DoubleSide,transparent:!0,depthWrite:!1,uniforms:{uTime:{value:0},uCurveIntensity:{value:1},uWindStrength:{value:.7},uGlowIntensity:{value:.5},uGlowColor:{value:new p.Color(65535)},uColor:{value:new p.Color(65535)},uSpeed:{value:1},uDirection:{value:1}},vertexShader:`
                varying vec2 vUv;
                varying vec3 vNormal;
                varying vec3 vPosition;
                uniform float uTime;
                uniform float uCurveIntensity;
                uniform float uSpeed;
                uniform float uDirection;
                
                void main() {
                    vUv = uv;
                    vNormal = normalize(normalMatrix * normal);
                    vPosition = position;
                    
                    // 修改顶点位置以创建弯曲效果
                    vec3 newPosition = position;
                    
                    // 创建更自然的风流弯曲效果
                    float windOffset = sin(uTime * uSpeed * 0.3 + position.y * 0.15) * uCurveIntensity * 0.08;
                    // 添加基于X轴位置的波动，使效果更复杂
                    float windOffset2 = cos(uTime * uSpeed * 0.25 + position.x * 0.1) * uCurveIntensity * 0.04;
                    // 根据Y轴位置调整弯曲程度，使中心区域效果更明显
                    float yFactor = 1.0 - pow(abs(position.y) / 0.4, 1.005);
                    newPosition.x += (windOffset + windOffset2) * uDirection * yFactor;
                    
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);
                }
            `,fragmentShader:`
                varying vec2 vUv;
                varying vec3 vNormal;
                varying vec3 vPosition;
                
                uniform float uTime;
                uniform float uWindStrength;
                uniform float uGlowIntensity;
                uniform vec3 uGlowColor;
                uniform vec3 uColor;
                uniform float uSpeed;
                uniform float uDirection;
                
                void main() {
                    // 计算Y轴渐变（从上到下透明度递减，并在边缘预留位置）
                    float yGradient = 1.0 - vUv.y;
                    // 在顶部和底部预留位置，使边缘完全透明
                    yGradient = smoothstep(0.4995, 0.5005, yGradient);
                    
                    // 添加时间相关的波动效果，结合速度参数
                    float wave = sin(uTime * uSpeed * 0.6 + vPosition.x * 0.8 + vPosition.y * 0.2) * 0.03;
                    // 添加第二个频率的波动
                    float wave2 = cos(uTime * uSpeed * 0.4 + vPosition.x * 0.4 + vPosition.y * 0.12) * 0.015;
                    
                    // 计算X轴渐变（中心透明度高，边缘低，并且边缘完全透明）
                    float xGradient = 1.0 - abs(vUv.x - 0.5) * 2.0;
                    // 在边缘预留位置，使效果边缘完全透明
                    xGradient = smoothstep(0.4998, 0.5002, xGradient);
                    
                    // 计算径向渐变（从中心到边缘透明度递减）
                    vec2 center = vec2(0.5, 0.5);
                    float distance = distance(vUv, center);
                    float radialGradient = 1.0 - distance * 1.0000005;
                    // 在边缘预留位置，使边缘完全透明
                    radialGradient = smoothstep(0.4995, 0.5005, radialGradient);
                    
                    // 综合透明度，结合速度影响
                    float alpha = yGradient * xGradient * radialGradient * uWindStrength + wave + wave2;
                    
                    // 确保透明度在合理范围内
                    alpha = clamp(alpha, 0.0, 1.0);
                    
                    // 添加颜色变化
                    vec3 color = uColor;
                    color.r += sin(uTime * uSpeed * 0.4 + vPosition.x * 0.1) * 0.03;
                    color.g += cos(uTime * uSpeed * 0.5 + vPosition.y * 0.04) * 0.03;
                    color.b += sin(uTime * uSpeed * 0.25 + vPosition.x * 0.05 + vPosition.y * 0.08) * 0.03;
                    
                    // 计算发光效果，结合速度参数
                    float glow = uGlowIntensity * (0.06 + abs(sin(uTime * uSpeed * 1.0 + vPosition.x * 0.5)) * 0.1);
                    vec3 glowColor = uGlowColor * glow * radialGradient;
                    
                    // 合成最终颜色
                    vec3 finalColor = color + glowColor;
                    
                    // 如果透明度太低则丢弃像素，使边缘完全透明
                    if (alpha < 0.00000005) discard;
                    
                    gl_FragColor = vec4(finalColor, alpha);
                }
            `,...e};super(t);l(this,"_curveIntensity",1);l(this,"_windStrength",.7);l(this,"_time",0);l(this,"_glowIntensity",.5);l(this,"_glowColor",new p.Color(65535));l(this,"_speed",1);l(this,"_direction",1);Object.defineProperties(this,{curveIntensity:{get:()=>this._curveIntensity,set:i=>{this._curveIntensity=i,this.uniforms.uCurveIntensity&&(this.uniforms.uCurveIntensity.value=i)}},windStrength:{get:()=>this._windStrength,set:i=>{this._windStrength=i,this.uniforms.uWindStrength&&(this.uniforms.uWindStrength.value=i)}},time:{get:()=>this._time,set:i=>{this._time=i,this.uniforms.uTime&&(this.uniforms.uTime.value=i)}},glowIntensity:{get:()=>this._glowIntensity,set:i=>{this._glowIntensity=i,this.uniforms.uGlowIntensity&&(this.uniforms.uGlowIntensity.value=i)}},glowColor:{get:()=>this._glowColor,set:i=>{this._glowColor=i,this.uniforms.uGlowColor&&(this.uniforms.uGlowColor.value=i)}},speed:{get:()=>this._speed,set:i=>{this._speed=i,this.uniforms.uSpeed&&(this.uniforms.uSpeed.value=i)}},direction:{get:()=>this._direction,set:i=>{this._direction=i,this.uniforms.uDirection&&(this.uniforms.uDirection.value=i)}}})}set curveIntensity(e){this._curveIntensity=e,this.uniforms.uCurveIntensity&&(this.uniforms.uCurveIntensity.value=e)}get curveIntensity(){return this._curveIntensity}set windStrength(e){this._windStrength=e,this.uniforms.uWindStrength&&(this.uniforms.uWindStrength.value=e)}get windStrength(){return this._windStrength}set time(e){this._time=e,this.uniforms.uTime&&(this.uniforms.uTime.value=e)}get time(){return this._time}set color(e){this.uniforms.uColor&&(this.uniforms.uColor.value=e)}get color(){var e;return((e=this.uniforms.uColor)==null?void 0:e.value)||new p.Color(65535)}set glowIntensity(e){this._glowIntensity=e,this.uniforms.uGlowIntensity&&(this.uniforms.uGlowIntensity.value=e)}get glowIntensity(){return this._glowIntensity}set glowColor(e){this._glowColor=e,this.uniforms.uGlowColor&&(this.uniforms.uGlowColor.value=e)}get glowColor(){return this._glowColor}set speed(e){this._speed=e,this.uniforms.uSpeed&&(this.uniforms.uSpeed.value=e)}get speed(){return this._speed}set direction(e){this._direction=e,this.uniforms.uDirection&&(this.uniforms.uDirection.value=e)}get direction(){return this._direction}}class Kt extends p.ShaderMaterial{constructor(e){const t={side:p.DoubleSide,transparent:!0,depthTest:!1,uniforms:{time:{value:1}},vertexShader:`
                varying vec3 vEC;
                uniform float time;
        
                float iqhash(float n) {
                    return fract(sin(n) * 43758.5453);
                }
        
                float noise(vec3 x) {
                    vec3 p = floor(x);
                    vec3 f = fract(x);
                    f = f * f * (3.0 - 2.0 * f);
                    float n = p.x + p.y * 57.0 + 113.0 * p.z;
                    return mix(mix(mix(iqhash(n), iqhash(n + 1.0), f.x),
                               mix(iqhash(n + 57.0), iqhash(n + 58.0), f.x), f.y),
                               mix(mix(iqhash(n + 113.0), iqhash(n + 114.0), f.x),
                               mix(iqhash(n + 170.0), iqhash(n + 171.0), f.x), f.y), f.z);
                }
        
                float xmb_noise2(vec3 x) {
                    return cos(x.z * 4.0) * cos(x.z + time / 10.0 + x.x);
                }
        
                void main() {
                    vec4 pos = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    vec3 v = vec3(pos.x, 0.0, pos.y);
                    vec3 v2 = v;
                    vec3 v3 = v;
        
                    v.y = xmb_noise2(v2) / 8.0;
        
                    v3.x -= time / 5.0;
                    v3.x /= 4.0;
        
                    v3.z -= time / 10.0;
                    v3.y -= time / 100.0;
        
                    v.z -= noise(v3 * 7.0) / 15.0;
                    v.y -= noise(v3 * 7.0) / 15.0 + cos(v.x * 2.0 - time / 2.0) / 5.0 - 0.3;
        
                    vEC = v;
                    gl_Position = vec4(v, 1.0);
                }
            `,fragmentShader:`
                uniform float time;
                varying vec3 vEC;
        
                void main()
                {
                   const vec3 up = vec3(0.0, 0.0, 1.0);
                   vec3 x = dFdx(vEC);
                   vec3 y = dFdy(vEC);
                   vec3 normal = normalize(cross(x, y));
                   float c = 1.0 - dot(normal, up);
                   c = (1.0 - cos(c * c)) / 3.0;
                   gl_FragColor = vec4(1.0, 1.0, 1.0, c * 1.5);
                }
            `,extensions:{derivatives:!0},...e};super(t);l(this,"_time",1);Object.defineProperties(this,{time:{get:()=>this._time,set:i=>{this._time=i,this.uniforms.time&&(this.uniforms.time.value=i)}}})}set time(e){this._time=e,this.uniforms.time&&(this.uniforms.time.value=e)}get time(){return this._time}}function W(h,s,e){return h+(s-h)*e}function qt(h,s,e){return{x:W(h.x,s.x,e),y:W(h.y,s.y,e),z:W(h.z,s.z,e)}}function Xt(h,s,e){return Math.min(Math.max(h,s),e)}function $t(h){return h*(Math.PI/180)}function Yt(h){return h*(180/Math.PI)}function Qt(h,s){return Math.random()*(s-h)+h}function Zt(h,s){return Math.floor(Math.random()*(s-h+1))+h}function Jt(h="bottomToTop"){const s=document.createElement("canvas");s.width=256,s.height=256;const e=s.getContext("2d");e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high";let t;switch(h){case"bottomToTop":t=e.createLinearGradient(0,s.height,0,0);break;case"topToBottom":t=e.createLinearGradient(0,0,0,s.height);break;case"leftToRight":t=e.createLinearGradient(0,0,s.width,0);break;case"rightToLeft":t=e.createLinearGradient(s.width,0,0,0);break;default:t=e.createLinearGradient(0,s.height,0,0)}t.addColorStop(0,"rgba(0, 0, 0, 0)"),t.addColorStop(.05,"rgba(0, 0, 0, 0.05)"),t.addColorStop(.5,"rgba(255, 255, 255, 0.5)"),t.addColorStop(.95,"rgba(255, 255, 255, 0.95)"),t.addColorStop(1,"rgba(255, 255, 255, 1)"),e.fillStyle=t,e.fillRect(0,0,s.width,s.height);const i=new p.CanvasTexture(s);return i.wrapS=p.RepeatWrapping,i.wrapT=p.RepeatWrapping,i.magFilter=p.LinearFilter,i.minFilter=p.LinearFilter,i}function es(h){return new Promise((s,e)=>{new p.TextureLoader().load(h,i=>{i.wrapS=p.RepeatWrapping,i.wrapT=p.RepeatWrapping,i.anisotropy=16,s(i)},void 0,e)})}class ts extends A{constructor(e){super();l(this,"directionalLights",new Map);l(this,"configs",new Map);l(this,"enabledMap",new Map);l(this,"selectedLightId",null);this.name="DirectionalLightScript",e&&(Array.isArray(e)?e.forEach(t=>{this.configs.set(t.id,t),this.enabledMap.set(t.id,!0)}):(this.configs.set(e.id,e),this.enabledMap.set(e.id,!0)))}start(){for(const[e,t]of this.configs)this.createLight(e,t)}createLight(e,t){const i=parseInt(t.color.replace("#","0x")),r=new p.DirectionalLight(i,t.intensity);r.position.set(t.position.x,t.position.y,t.position.z);const n=new p.Object3D;n.position.set(t.target.x,t.target.y,t.target.z),this.scene&&this.scene.add(n),r.target=n,r.castShadow=!0,r.shadow.mapSize.width=2048,r.shadow.mapSize.height=2048,r.shadow.camera.near=.5,r.shadow.camera.far=500,r.shadow.camera.left=-50,r.shadow.camera.right=50,r.shadow.camera.top=50,r.shadow.camera.bottom=-50,r.userData={id:t.id,name:t.name},this.scene&&this.isEnabled(e)&&this.scene.add(r),this.directionalLights.set(e,r)}addLight(e){if(this.configs.has(e.id)){console.warn(`Light with ID ${e.id} already exists`);return}this.configs.set(e.id,e),this.enabledMap.set(e.id,!0),this.createLight(e.id,e)}removeLight(e){if(!this.configs.has(e)){console.warn(`Light with ID ${e} does not exist`);return}const t=this.directionalLights.get(e);t&&t.parent&&(t.target&&t.target.parent&&t.target.parent.remove(t.target),t.parent.remove(t)),this.directionalLights.delete(e),this.configs.delete(e),this.enabledMap.delete(e),this.selectedLightId===e&&(this.selectedLightId=null)}updateConfig(e,t){if(!this.configs.has(e)){console.warn(`Light with ID ${e} does not exist`);return}const r={...this.configs.get(e),...t};this.configs.set(e,r);const n=this.directionalLights.get(e);if(n){if(t.color!==void 0){const o=parseInt(t.color.replace("#","0x"));n.color.set(o)}t.intensity!==void 0&&(n.intensity=t.intensity),t.position!==void 0&&n.position.set(t.position.x??n.position.x,t.position.y??n.position.y,t.position.z??n.position.z),t.target!==void 0&&n.target&&n.target.position.set(t.target.x??n.target.position.x,t.target.y??n.target.position.y,t.target.z??n.target.position.z)}}enable(e){if(!this.configs.has(e)){console.warn(`Light with ID ${e} does not exist`);return}this.enabledMap.set(e,!0);const t=this.directionalLights.get(e);t&&this.scene&&!t.parent&&(this.scene.add(t),t.target&&!t.target.parent&&this.scene&&this.scene.add(t.target))}disable(e){if(!this.configs.has(e)){console.warn(`Light with ID ${e} does not exist`);return}this.enabledMap.set(e,!1);const t=this.directionalLights.get(e);t&&t.parent&&(t.parent.remove(t),t.target&&t.target.parent&&t.target.parent.remove(t.target))}isEnabled(e){return this.enabledMap.get(e)??!1}getAllConfigs(){return new Map(this.configs)}getConfig(e){return this.configs.get(e)}getAllLights(){return new Map(this.directionalLights)}getLight(e){return this.directionalLights.get(e)}selectLight(e){if(!this.configs.has(e)){console.warn(`Light with ID ${e} does not exist`);return}this.selectedLightId=e}deselectLight(){this.selectedLightId=null}getSelectedLightId(){return this.selectedLightId}getSelectedLightConfig(){if(this.selectedLightId)return this.configs.get(this.selectedLightId)}getSelectedLight(){if(this.selectedLightId)return this.directionalLights.get(this.selectedLightId)}toggleLight(e){this.isEnabled(e)?this.disable(e):this.enable(e)}destroy(){Array.from(this.directionalLights.values()).forEach(e=>{e.parent&&(e.target&&e.target.parent&&e.target.parent.remove(e.target),e.parent.remove(e))}),this.directionalLights.clear(),this.configs.clear(),this.enabledMap.clear(),this.selectedLightId=null}}class ss extends A{constructor(e){super();l(this,"pointLights",new Map);l(this,"configs",new Map);l(this,"enabledMap",new Map);l(this,"selectedLightId",null);e&&(Array.isArray(e)?e.forEach(t=>{this.configs.set(t.id,t),this.enabledMap.set(t.id,!0)}):(this.configs.set(e.id,e),this.enabledMap.set(e.id,!0)))}start(){for(const[e,t]of this.configs)this.createLight(e,t)}createLight(e,t){const i=parseInt(t.color.replace("#","0x")),r=new p.PointLight(i,t.intensity,t.distance,t.decay);r.position.set(t.position.x,t.position.y,t.position.z),r.userData={id:t.id,name:t.name},this.scene&&this.isEnabled(e)&&this.scene.add(r),this.pointLights.set(e,r)}addLight(e){if(this.configs.has(e.id)){console.warn(`Light with ID ${e.id} already exists`);return}this.configs.set(e.id,e),this.enabledMap.set(e.id,!0),this.createLight(e.id,e)}removeLight(e){if(!this.configs.has(e)){console.warn(`Light with ID ${e} does not exist`);return}const t=this.pointLights.get(e);t&&t.parent&&t.parent.remove(t),this.pointLights.delete(e),this.configs.delete(e),this.enabledMap.delete(e),this.selectedLightId===e&&(this.selectedLightId=null)}updateConfig(e,t){if(!this.configs.has(e)){console.warn(`Light with ID ${e} does not exist`);return}const r={...this.configs.get(e),...t};this.configs.set(e,r);const n=this.pointLights.get(e);if(n){if(t.color!==void 0){const o=parseInt(t.color.replace("#","0x"));n.color.set(o)}t.intensity!==void 0&&(n.intensity=t.intensity),t.distance!==void 0&&(n.distance=t.distance),t.decay!==void 0&&(n.decay=t.decay),t.position!==void 0&&n.position.set(t.position.x??n.position.x,t.position.y??n.position.y,t.position.z??n.position.z)}}enable(e){if(!this.configs.has(e)){console.warn(`Light with ID ${e} does not exist`);return}this.enabledMap.set(e,!0);const t=this.pointLights.get(e);t&&this.scene&&!t.parent&&this.scene.add(t)}disable(e){if(!this.configs.has(e)){console.warn(`Light with ID ${e} does not exist`);return}this.enabledMap.set(e,!1);const t=this.pointLights.get(e);t&&t.parent&&t.parent.remove(t)}isEnabled(e){return this.enabledMap.get(e)??!1}getAllConfigs(){return new Map(this.configs)}getConfig(e){return this.configs.get(e)}getAllLights(){return new Map(this.pointLights)}getLight(e){return this.pointLights.get(e)}selectLight(e){if(!this.configs.has(e)){console.warn(`Light with ID ${e} does not exist`);return}this.selectedLightId=e}deselectLight(){this.selectedLightId=null}getSelectedLightId(){return this.selectedLightId}getSelectedLightConfig(){if(this.selectedLightId)return this.configs.get(this.selectedLightId)}getSelectedLight(){if(this.selectedLightId)return this.pointLights.get(this.selectedLightId)}toggleLight(e){this.isEnabled(e)?this.disable(e):this.enable(e)}destroy(){Array.from(this.pointLights.values()).forEach(e=>{e.parent&&e.parent.remove(e)}),this.pointLights.clear(),this.configs.clear(),this.enabledMap.clear(),this.selectedLightId=null}}b.THREE=p,Object.defineProperty(b,"EffectComposer",{enumerable:!0,get:()=>D.EffectComposer}),Object.defineProperty(b,"RenderPass",{enumerable:!0,get:()=>q.RenderPass}),Object.defineProperty(b,"ShaderPass",{enumerable:!0,get:()=>Re.ShaderPass}),Object.defineProperty(b,"OutputPass",{enumerable:!0,get:()=>ae.OutputPass}),Object.defineProperty(b,"UnrealBloomPass",{enumerable:!0,get:()=>ce.UnrealBloomPass}),Object.defineProperty(b,"OutlinePass",{enumerable:!0,get:()=>Ie.OutlinePass}),Object.defineProperty(b,"SSRPass",{enumerable:!0,get:()=>_e.SSRPass}),Object.defineProperty(b,"Reflector",{enumerable:!0,get:()=>X.Reflector}),Object.defineProperty(b,"ReflectorForSSRPass",{enumerable:!0,get:()=>De.ReflectorForSSRPass}),Object.defineProperty(b,"HorizontalBlurShader",{enumerable:!0,get:()=>$.HorizontalBlurShader}),Object.defineProperty(b,"VerticalBlurShader",{enumerable:!0,get:()=>Y.VerticalBlurShader}),Object.defineProperty(b,"CSS2DObject",{enumerable:!0,get:()=>V.CSS2DObject}),Object.defineProperty(b,"CSS2DRenderer",{enumerable:!0,get:()=>V.CSS2DRenderer}),Object.defineProperty(b,"RectAreaLightUniformsLib",{enumerable:!0,get:()=>le.RectAreaLightUniformsLib}),Object.defineProperty(b,"RectAreaLightHelper",{enumerable:!0,get:()=>he.RectAreaLightHelper}),Object.defineProperty(b,"OrbitControls",{enumerable:!0,get:()=>de.OrbitControls}),b.Stats=Ee,b.TWEEN=E,b.Aether3d=We,b.AnimationMaterial=Ht,b.BatchDOMUpdater=be,b.BloomEffectScript=it,b.CacheManager=Ue,b.DetailedPerformanceProfiler=Se,b.DevicePerformanceDetector=Ne,b.DirectionalLightScript=ts,b.EventEmitter=pe,b.FPSDiagnosticTool=we,b.FrameRateLimiter=me,b.FrameRateMonitor=ye,b.GLBLoaderScript=Gt,b.GeometryOptimizer=Ge,b.MemoryMonitor=Fe,b.MirrorReflectionScript=et,b.MouseInteractionScript=Z,b.ObjectPool=j,b.OrbitControlsScript=tt,b.PerformanceProfiler=ge,b.PointLightScript=ss,b.RectAreaLightScript=J,b.RenderBatcher=ze,b.RenderPerformanceOptimizer=Q,b.RibbonMaterial=Kt,b.SceneLightingScript=st,b.SceneManager=R,b.ScriptBase=A,b.ShaderGlowMaterial=Vt,b.TextureOptimizer=ve,b.UVAnimationScript=zt,b.WindMaterial=Wt,b.addScript=Ze,b.clamp=Xt,b.createCamera=Le,b.createGradientAlphaMap=Jt,b.createPostprocessing=Ye,b.createScene=Xe,b.debounce=Be,b.degToRad=$t,b.globalRenderer=L,b.isGlobalRendererReady=qe,b.lerp=W,b.lerpVector=qt,b.loadTexture=es,b.os=Ve,b.radToDeg=Yt,b.randomIntRange=Zt,b.randomRange=Qt,b.removeScript=Je,b.render=$e,b.setupContextEvents=Qe,b.throttle=ke,Object.defineProperty(b,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=aether3d-engine.umd.js.map
